# 開発環境構築

このドキュメントでは、Consultant TODO Appの開発環境を構築する手順を説明します。

## 前提条件

- Windows 10/11がインストールされていること
- Visual Studio Codeがインストールされていること
  - https://code.visualstudio.com/Download
- GitHubからgitでリポジトリを取得できること
  - VS Code経由で取得する例: https://qiita.com/Hiro_tech/items/82183bb30ab44e58ae47
- Gitの改行コード設定を適切に行うこと
  - WSLから実行する場合、チェックアウト時にCRLFに変換しない設定が必要
  - 参考: https://qiita.com/uggds/items/00a1974ec4f115616580
  - 設定コマンド: `git config --local core.autocrlf input`

## 1. WSL2のインストール

Windows Subsystem for Linux (WSL2) をインストールします。WSL2により、Windows上でLinux環境を利用できます。

### 1.1 WSL2のインストール

PowerShellを**管理者権限で**起動し、以下のコマンドを実行します：

```powershell
wsl --install -d Ubuntu-20.04
```

実行結果の例：

```
Windows オプション コンポーネントをインストールしています: VirtualMachinePlatform

展開イメージのサービスと管理ツール
バージョン: 10.0.22621.2792

イメージのバージョン: 10.0.22631.4037

機能を有効にしています
[==========================100.0%==========================]
操作は正常に完了しました。
要求された操作は正常に終了しました。変更を有効にするには、システムを再起動する必要があります。
インストール中: Ubuntu 20.04 LTS
Ubuntu 20.04 LTS がインストールされました。
要求された操作は正常に終了しました。変更を有効にするには、システムを再起動する必要があります。
```

### 1.2 Windowsの再起動

インストール後、必ずWindowsを再起動します。

### 1.3 Ubuntuの初期設定

再起動後、Windowsのアプリ検索で「Ubuntu」を検索して起動します。

ターミナルが起動したら、任意のユーザー名とパスワードを設定します：

```
Installing, this may take a few minutes...
Please create a default UNIX user account. The username does not need to match your Windows username.
For more information visit: https://aka.ms/wslusers
Enter new UNIX username: toozawa
New password:
Retype new password:
passwd: password updated successfully
Installation successful!
```

## 2. VS Codeの設定

### 2.1 プロジェクトを開く

VS Codeから、クローンしたプロジェクトのフォルダを開きます。

### 2.2 WSLターミナルを起動

`Ctrl + J` でコンソールを開き、右上の「+」ボタンの横にあるプルダウンメニューから「Ubuntu (WSL)」を選択します。

### 2.3 bashrcの設定（オプション）

フルパス表示が長すぎる場合は、ベースディレクトリ表示に変更できます：

```bash
vi ~/.bashrc
```

以下の箇所の `/w` を `/W` に修正します：

```bash
# 変更前
if [ "$color_prompt" = yes ]; then
    PS1='${debian_chroot:+($debian_chroot)}\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
else
    PS1='${debian_chroot:+($debian_chroot)}\u@\h:\w\$ '
fi

# 変更後（\w を \W に）
if [ "$color_prompt" = yes ]; then
    PS1='${debian_chroot:+($debian_chroot)}\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\W\[\033[00m\]\$ '
else
    PS1='${debian_chroot:+($debian_chroot)}\u@\h:\W\$ '
fi
```

### 2.4 タイムゾーンの設定

時刻をUTCに合わせます：

```bash
sudo timedatectl set-timezone UTC
```

設定後、ターミナルを再起動します。

## 3. asdfのインストール

asdfは、Node.jsやTerraformなど複数のツールのバージョンを一元管理できるツールです。

### 3.1 システムパッケージの更新

```bash
sudo apt update
```

### 3.2 asdfのインストール

最新の安定版（v0.14.1）をインストールします：

```bash
git clone https://github.com/asdf-vm/asdf.git ~/.asdf --branch v0.14.1
echo '. "$HOME/.asdf/asdf.sh"' >> ~/.bashrc
echo '. "$HOME/.asdf/completions/asdf.bash"' >> ~/.bashrc
source ~/.bashrc
```

### 3.3 インストール確認

以下のコマンドでパスが通っていることを確認します：

```bash
which asdf
# 出力: /home/toozawa/.asdf/bin/asdf
```

## 4. Node.jsのインストール

### 4.1 Node.jsプラグインの追加

```bash
asdf plugin add nodejs https://github.com/asdf-vm/asdf-nodejs.git
```

### 4.2 Node.jsのインストール

プロジェクトのルートディレクトリに移動し、`.tool-versions`ファイルに記載されたバージョンをインストールします：

```bash
cd /mnt/c/Users/<your-username>/Documents/workspace/hands-on
asdf install nodejs
```

バージョンを確認します：

```bash
node -v
# 出力: v22.11.0

npm -v
# 出力: 10.9.0（またはそれ以降）
```

**注意**: バージョンが反映されない場合は、ターミナルを再起動してください。

## 5. Terraformのインストール

### 5.1 Terraformプラグインの追加

```bash
asdf plugin add terraform https://github.com/asdf-community/asdf-hashicorp.git
```

### 5.2 Terraformのインストール

```bash
asdf install terraform
```

### 5.3 インストール確認

```bash
terraform version
# 出力: Terraform v1.11.3
```

## 6. 依存関係のインストール

プロジェクトのルートディレクトリで、npm パッケージをインストールします：

```bash
npm ci
```

このコマンドにより、server、web、infraすべてのワークスペースの依存関係がインストールされます。

## 7. Dockerのインストール

バックエンドのテスト用にDynamoDB Localを実行するため、Dockerが必要です。

### 7.1 必要なパッケージのインストール

```bash
sudo apt-get update
sudo apt-get install \
  ca-certificates \
  curl \
  gnupg \
  lsb-release
```

### 7.2 DockerのGPGキーを追加

```bash
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
```

### 7.3 Dockerリポジトリを追加

```bash
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```

### 7.4 Dockerのインストール

```bash
sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io
```

### 7.5 インストール確認

```bash
docker -v
# 出力: Docker version 27.3.0, build e85edf8（バージョンは異なる場合があります）
```

### 7.6 DynamoDB Localの起動

```bash
cd server
sudo docker compose up -d
cd ..
```

起動確認：

```bash
sudo docker ps
# DynamoDBコンテナが起動していることを確認
```

## 8. 動作確認

### 8.1 テストの実行

バックエンドのテストが全てパスすることを確認します：

```bash
npm run test -w server
```

すべてのテストが成功すれば、環境構築は完了です。

### 8.2 バリデーションの実行

コードの品質チェック（TypeScript型チェック + ESLint）を実行します：

```bash
npm run validate -w server
```

もしエラーが出る場合は、自動フォーマットを実行してから再度確認します：

```bash
npm run fix:format -w server
npm run validate -w server
```

### 8.3 フロントエンドの動作確認

開発サーバーを起動して、ブラウザで動作を確認します：

```bash
npm run dev -w web
```

ブラウザで `http://localhost:5173` にアクセスし、アプリケーションが表示されることを確認します。

## 9. Gitの設定

### 9.1 コミットテンプレートの設定

コミットメッセージのテンプレートを設定します：

```bash
git config commit.template ./.github/.COMMIT_TEMPLATE
```

これにより、`git commit`実行時にテンプレートが自動的に表示されます。

### 9.2 ユーザー情報の設定（初回のみ）

Gitの初回利用時は、ユーザー名とメールアドレスを設定します：

```bash
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"
```

## 10. AWS CLIのインストール（オプション）

AWSへのデプロイを行う場合は、AWS CLIが必要です。

### 10.1 AWS CLI v2のインストール

```bash
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
sudo apt-get install unzip
unzip awscliv2.zip
sudo ./aws/install
```

### 10.2 インストール確認

```bash
aws --version
# 出力: aws-cli/2.x.x Python/3.x.x Linux/x.x.x
```

### 10.3 AWS認証情報の設定

```bash
aws configure
```

以下の情報を入力します：
- AWS Access Key ID
- AWS Secret Access Key
- Default region name: `ap-northeast-1`
- Default output format: `json`

## トラブルシューティング

### WSL2が起動しない

- Windows Updateを最新にする
- BIOSで仮想化機能（VT-x/AMD-V）が有効になっているか確認
- PowerShellを管理者権限で実行しているか確認

### asdfでツールがインストールできない

```bash
# asdfを再インストール
rm -rf ~/.asdf
git clone https://github.com/asdf-vm/asdf.git ~/.asdf --branch v0.14.1
source ~/.bashrc
```

### Dockerがpermission deniedエラーになる

```bash
# Dockerグループにユーザーを追加
sudo usermod -aG docker $USER

# ログアウトして再ログイン、またはターミナルを再起動
```

### DynamoDB Localが起動しない

```bash
# Dockerサービスを再起動
sudo service docker restart

# コンテナを削除して再作成
cd server
sudo docker compose down
sudo docker compose up -d
```

### ポート8000が既に使用されている

```bash
# ポートを使用しているプロセスを確認
lsof -i :8000

# 必要に応じてプロセスを停止
```

## 次のステップ

開発環境の構築が完了したら、以下のドキュメントを参照してください：

- [アーキテクチャ概要](../../README.md#アーキテクチャ概要)
- [開発コマンド](../../README.md#開発コマンド)
- [デプロイ手順](../../README.md#デプロイ)

## 参考リンク

- [asdf公式ドキュメント](https://asdf-vm.com/)
- [WSL2公式ドキュメント](https://docs.microsoft.com/ja-jp/windows/wsl/)
- [Docker公式ドキュメント](https://docs.docker.com/)
- [Terraform公式ドキュメント](https://www.terraform.io/docs)
- [AWS CLI公式ドキュメント](https://docs.aws.amazon.com/cli/)
