# Use Case層 - アプリケーションビジネスロジック

アプリケーション固有のビジネスルールを実装する層。ドメインエンティティとリポジトリを組み合わせて、ユーザーのアクションを実現。

## 責務

- **ユーザーアクションの実行**: 1つのユースケース = 1つのユーザーアクション
- **エンティティの協調**: 複数のエンティティやリポジトリを組み合わせたロジック
- **トランザクション管理**: Unit of Workパターンでデータ整合性を保証
- **エラーハンドリング**: Result型で明示的なエラー処理

## ディレクトリ構成

```
use-case/
├── {entity}/                          # エンティティごとにディレクトリ
│   ├── {action}-{entity}-use-case.ts           # ユースケース実装
│   └── {action}-{entity}-use-case.small.test.ts # ユニットテスト
└── interfaces.ts                      # 共通インターフェース
```

**命名パターン:**

- ファイル名: `{action}-{entity}-use-case.ts`
- クラス名: `{Action}{Entity}UseCase` または `{Action}{Entity}UseCaseImpl`
- アクション例: `register`, `get`, `list`, `update`, `delete`

## 核となる設計原則

### 1. 単一責任原則

1つのユースケース = 1つのユーザーアクション。

- 複数の操作を1つのユースケースに含めない
- ビジネストランザクションの境界を明確に
- テストしやすい粒度に分割

### 2. 明示的な型定義

入力・出力・エラーを明確に型定義。

**必須の型定義:**

- `{UseCase}Input` - 実行に必要な引数
- `{UseCase}Output` - 成功時の戻り値
- `{UseCase}Exception` - 発生しうるエラー型のユニオン
- `{UseCase}Result` - `Result<Output, Exception>`

### 3. Result型パターン

例外を投げず、Result型で成功/失敗を返す。

**利点:**

- 型システムでエラーハンドリングを強制
- どのエラーが発生するか型で明示
- ハンドラ層でのエラー変換が容易

### 4. 依存性注入

コンストラクタで依存を注入。

**注入する依存:**

- リポジトリ（データアクセス）
- Logger（ログ出力）
- FetchNow（時刻取得）
- AuthClient（認証操作）
- 他のユースケース（必要な場合のみ）

## ユースケースパターン

### 基本構造

**クラス定義:**

- privateフィールドで依存を保持
- コンストラクタで依存を注入
- executeメソッドで処理を実行

**executeメソッド:**

- Propsパターンで引数を受け取る
- `async` で非同期処理
- `Promise<Result<T, E>>` を返す

### CRUD操作パターン

#### 1. 作成（Register/Create）

**処理フロー:**

1. 入力バリデーション
2. ID生成（リポジトリメソッド使用）
3. エンティティ生成（コンストラクタ呼び出し）
4. リポジトリで保存
5. 保存結果を返す

**注意点:**

- 重複チェックが必要な場合は事前にfindで確認
- ConflictErrorで重複を通知

#### 2. 取得（Get/Find）

**処理フロー:**

1. リポジトリでエンティティ検索
2. 見つからない場合はNotFoundError
3. 見つかった場合はエンティティを返す

**注意点:**

- undefinedチェックを忘れずに
- 権限チェックが必要な場合は実施

#### 3. 一覧取得（List）

**処理フロー:**

1. クエリパラメータの準備
2. リポジトリでリスト取得
3. 空配列も正常系として扱う

**注意点:**

- ページネーション対応が必要な場合はcursorやlimitを引数に
- フィルタ条件を型安全に定義

#### 4. 更新（Update）

**処理フロー:**

1. リポジトリで既存エンティティ取得
2. 見つからない場合はNotFoundError
3. エンティティの更新メソッド呼び出し（immutable）
4. リポジトリで保存
5. 更新後エンティティを返す

**注意点:**

- エンティティは不変なので新しいインスタンスを生成
- 楽観的ロックが必要な場合はバージョン管理

#### 5. 削除（Delete）

**処理フロー:**

1. リポジトリで既存エンティティ確認
2. 見つからない場合はNotFoundError
3. リポジトリで削除
4. 削除結果を返す

**注意点:**

- 論理削除 vs 物理削除の判断
- 関連データの削除や整合性チェック

### Current Userパターン

認証済みユーザー自身の操作を実装するパターン。

**特徴:**

- ファイル名: `*-current-user-use-case.ts`
- 引数にCognito Sub（`sub: string`）を受け取る
- リポジトリの`findBySub()`メソッドを使用
- 権限チェック不要（自分自身の操作のため）

**使用例:**

- ユーザー登録（初回ログイン時）
- プロフィール取得
- プロフィール更新
- アカウント削除

### トランザクションパターン

複数のリポジトリ操作をトランザクションで実行。

**パターン:**

1. Unit of Workを注入
2. `unitOfWork.run()` でトランザクション開始
3. コールバック内で複数のリポジトリ操作
4. 全て成功すれば自動コミット、失敗時はロールバック

**使用例:**

- ユーザー削除 + 認証プロバイダからの削除
- 複数エンティティの同時更新

## エラーハンドリング

### エラー型の定義

ユースケースで発生しうる全エラーをユニオン型で定義。

**標準エラー型:**

- `NotFoundError` - リソースが見つからない
- `ValidationError` - 入力バリデーションエラー
- `ConflictError` - リソース重複
- `UnexpectedError` - 予期しないエラー

**カスタムエラー:**

- 業務ルール違反を表現する独自エラー型を定義可能

### エラー変換

リポジトリのエラーをそのまま返すか、ユースケース固有のエラーに変換。

**パターン:**

- リポジトリエラーをそのまま返す（共通エラーの場合）
- ビジネス文脈に合わせてエラーメッセージを追加
- 複数のエラーを1つにまとめる（必要な場合）

## ロギング

### ログ出力のタイミング

- **開始時**: ユースケース実行開始（`info`）
- **成功時**: 操作完了（`info`）
- **失敗時**: エラー詳細（`error`）
- **警告時**: 非推奨機能使用など（`warn`）

### ログに含める情報

- ユースケース名
- 入力パラメータ（機密情報を除く）
- 実行結果（成功/失敗）
- エラー詳細（スタックトレース含む）
- 実行時間（パフォーマンス測定）

## DI設定

### サービスID命名規則

`{ACTION}_{ENTITY}_USE_CASE`

**例:**

- `REGISTER_TODO_USE_CASE`
- `GET_CURRENT_USER_USE_CASE`
- `LIST_USERS_USE_CASE`

### 登録パターン

**DIコンテナに登録:**

1. `service-id.ts` にサービスID追加
2. `register-lambda-container.ts` にバインディング追加
3. 依存するリポジトリとユーティリティを注入
4. Singleton スコープで登録

## テスト戦略

### スモールテスト（ユニットテスト）

**ファイル名**: `{action}-{entity}-use-case.small.test.ts`

**テスト内容:**

- 正常系: 期待通りの結果が返る
- 異常系: 各エラーケースで適切なエラーが返る
- 境界値: エッジケースの動作確認

**モック使用:**

- リポジトリ: Dummyリポジトリ
- Logger: LoggerDummy
- FetchNow: 固定日時を返す関数
- AuthClient: AuthClientDummy

### ミディアムテスト

ユースケース層では通常不要。リポジトリの統合テストで十分。

### 統合テスト

E2Eテストでユースケースを含むフロー全体をテスト。

## 実装時のチェックリスト

新しいユースケースを追加する際の確認事項：

- [ ] Input/Output/Exception/Result型を定義
- [ ] Propsパターンで引数を受け取る
- [ ] Result型で戻り値を返す
- [ ] 依存をコンストラクタで注入
- [ ] エンティティの不変性を保つ（更新時は新インスタンス生成）
- [ ] エラーケースを全て型定義
- [ ] ロギングを適切に実施
- [ ] スモールテストを作成
- [ ] DIコンテナに登録
- [ ] サービスIDを追加

## 参考

- `server/README.md` - サーバー全体のアーキテクチャ
- `../domain/README.md` - ドメイン層の設計原則
- `../domain/model/{entity}/{entity}-repository.ts` - リポジトリインターフェース
- `../domain/support/logger/README.md` - Loggerの使い方
- `../domain/support/auth-client/README.md` - AuthClientの使い方
- `../domain/support/unit-of-work/README.md` - トランザクション管理
- `../handler/README.md` - ハンドラ層でのユースケース呼び出し
- `../di-container/README.md` - DI設定
