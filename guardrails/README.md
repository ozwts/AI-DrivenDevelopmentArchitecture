# Guardrails - ä¸‰æ¨©åˆ†ç«‹ã‚·ã‚¹ãƒ†ãƒ 

AIãŒè‡ªèµ°ã™ã‚‹ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«ã«ä¸‰æ¨©åˆ†ç«‹ã®æ¦‚å¿µã‚’å°å…¥ã—ãŸã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

## æ¦‚è¦

```
Constitutionï¼ˆæ†²æ³•: æœ€é«˜åŸå‰‡ï¼‰
    â†“
Policyï¼ˆç«‹æ³•: ãƒ«ãƒ¼ãƒ«å®šç¾©ï¼‰
    â†“ [MCPã‚µãƒ¼ãƒãƒ¼ãŒä¸¦åˆ—èª­ã¿è¾¼ã¿]
Reviewï¼ˆå¸æ³•: Claude Agent SDKã§å¯©æŸ»å®Ÿè¡Œï¼‰
    â†“ [ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’è¿”ã™]
```

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
guardrails/
â”œâ”€â”€ package.json          # ãƒ“ãƒ«ãƒ‰è¨­å®š
â”œâ”€â”€ tsconfig.json         # TypeScriptè¨­å®š
â”œâ”€â”€ index.ts              # MCPã‚µãƒ¼ãƒãƒ¼ï¼ˆçµ±åˆã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼‰
â”œâ”€â”€ constitution/         # æ†²æ³•ï¼ˆæœ€é«˜åŸå‰‡ãƒ»ä¾¡å€¤ãƒ»æ³•ä»¤ãƒ»å€«ç†ï¼‰
â”‚   â”œâ”€â”€ validation-principles.md     # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³åŸå‰‡ï¼ˆMECEï¼‰
â”‚   â””â”€â”€ observability-principles.md  # å¯è¦³æ¸¬æ€§åŸå‰‡ï¼ˆAIè‡ªå¾‹é–‹ç™ºã¨äººé–“ã®è²¬ä»»æ‹…ä¿ï¼‰
â”œâ”€â”€ policy/              # ç«‹æ³•ï¼ˆæ†²æ³•ã‚’å…·ä½“åŒ–ã—ãŸãƒ«ãƒ¼ãƒ«ç¾¤ï¼‰
â”‚   â”œâ”€â”€ web/
â”‚   â”‚   â””â”€â”€ test-strategy/
â”‚   â”‚       â”œâ”€â”€ 00-test-coverage-requirements.md
â”‚   â”‚       â”œâ”€â”€ 10-test-strategy-overview.md
â”‚   â”‚       â”œâ”€â”€ 20-component-test.md
â”‚   â”‚       â””â”€â”€ 30-snapshot-test.md
â”‚   â””â”€â”€ server/
â”‚       â””â”€â”€ domain-model/
â”‚           â”œâ”€â”€ 10-domain-model-overview.md
â”‚           â”œâ”€â”€ 20-entity-design.md
â”‚           â”œâ”€â”€ 30-repository-interface.md
â”‚           â””â”€â”€ 40-aggregate-pattern.md
â”œâ”€â”€ review/              # å¸æ³•ï¼ˆPolicyã«å¾“ã£ã¦å¯©æŸ»ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ï¼‰
â”‚   â”œâ”€â”€ web/
â”‚   â”‚   â””â”€â”€ test-strategy/
â”‚   â”‚       â”œâ”€â”€ index.ts              # MCPãƒãƒ³ãƒ‰ãƒ©ãƒ¼
â”‚   â”‚       â”œâ”€â”€ test-reviewer.ts      # ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ
â”‚   â”‚       â”œâ”€â”€ coverage-checker.ts   # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯
â”‚   â”‚       â””â”€â”€ formatter.ts          # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼
â”‚   â””â”€â”€ server/
â”‚       â””â”€â”€ domain-model/
â”‚           â”œâ”€â”€ index.ts              # MCPãƒãƒ³ãƒ‰ãƒ©ãƒ¼
â”‚           â”œâ”€â”€ domain-reviewer.ts    # ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ
â”‚           â””â”€â”€ formatter.ts          # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼
â””â”€â”€ procedure/           # è¡Œæ”¿ï¼ˆPolicyã«å¾“ã£ã¦å‹•ãå®Ÿè¡Œãƒ»ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
```

## ä¸‰æ¨©åˆ†ç«‹ã®å¯¾å¿œ

| å½¹å‰² | ãƒ•ã‚©ãƒ«ãƒ€      | èª¬æ˜                                   | æ‹…å½“    |
| ---- | ------------- | -------------------------------------- | ------- |
| æ†²æ³• | constitution/ | æœ€é«˜åŸå‰‡ãƒ»ä¾¡å€¤ãƒ»æ³•ä»¤ãƒ»å€«ç†             | äººé–“    |
| ç«‹æ³• | policy/       | æ†²æ³•ã‚’å…·ä½“åŒ–ã—ãŸãƒ«ãƒ¼ãƒ«ç¾¤               | äººé–“    |
| å¸æ³• | review/       | Policyã«å¾“ã£ã¦å¯©æŸ»ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ï¼ˆMCPï¼‰  | AI      |
| è¡Œæ”¿ | procedure/    | Policyã«å¾“ã£ã¦å‹•ãå®Ÿè¡Œãƒ»ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ | AI/äººé–“ |

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
cd guardrails
npm install
```

### 2. ãƒ“ãƒ«ãƒ‰

```bash
npm run build
```

### 3. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

```bash
export ANTHROPIC_API_KEY="your-api-key-here"
```

### 4. Claude Desktopè¨­å®š

`~/Library/Application Support/Claude/claude_desktop_config.json` ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

```json
{
  "mcpServers": {
    "guardrails": {
      "command": "node",
      "args": ["/Users/your-username/path/to/guardrails/dist/index.js"],
      "env": {
        "ANTHROPIC_API_KEY": "your-api-key-here"
      }
    }
  }
}
```

## ä½¿ã„æ–¹

### MCPãƒ„ãƒ¼ãƒ«1: `review_web_tests`

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ†ã‚¹ãƒˆæˆ¦ç•¥ãƒãƒªã‚·ãƒ¼ã«æº–æ‹ ã—ã¦ã„ã‚‹ã‹ã‚’å¯©æŸ»ã—ã¾ã™ã€‚

#### å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«

- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆï¼ˆ`*.ct.test.tsx`ï¼‰
- ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆ`*.ss.test.ts`ï¼‰

#### å…¥åŠ›

```json
{
  "targetFilePaths": [
    "/path/to/TodoForm.ct.test.tsx",
    "/path/to/TodoCard.ct.test.tsx",
    "/path/to/ProjectForm.ct.test.tsx"
  ]
}
```

#### å‡¦ç†ãƒ•ãƒ­ãƒ¼

1. **å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸¦åˆ—å‡¦ç†**ï¼ˆPromise.allï¼‰
   - ãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥åˆ¤å®šï¼ˆ.ct.test.tsx / .ss.test.tsï¼‰
   - ãƒãƒªã‚·ãƒ¼é¸æŠãƒ»ä¸¦åˆ—èª­ã¿è¾¼ã¿
   - Claude APIã§ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ
2. **çµæœã‚’é›†ç´„**ã—ã¦è¿”ã™

#### å‡ºåŠ›ä¾‹

```markdown
# ğŸ“ å€‹åˆ¥ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ¬ãƒ“ãƒ¥ãƒ¼

## ã‚µãƒãƒªãƒ¼

- ç·ãƒ•ã‚¡ã‚¤ãƒ«æ•°: 3
- æˆåŠŸ: 3
- å¤±æ•—: 0

---

## TodoForm.ct.test.tsx

### é©ç”¨ã•ã‚ŒãŸãƒãƒªã‚·ãƒ¼

- 10-test-strategy-overview.md
- 20-component-test.md

### ãƒ¬ãƒ“ãƒ¥ãƒ¼

[Claudeã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹]
...
```

### MCPãƒ„ãƒ¼ãƒ«2: `review_domain_models`

ã‚µãƒ¼ãƒãƒ¼å´ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ãƒãƒªã‚·ãƒ¼ã«æº–æ‹ ã—ã¦ã„ã‚‹ã‹ã‚’å¯©æŸ»ã—ã¾ã™ã€‚

#### å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«

- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆ`*.ts`ã€ãŸã ã—`*-repository.ts`ä»¥å¤–ï¼‰
- ãƒªãƒã‚¸ãƒˆãƒªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆ`*-repository.ts`ï¼‰
- é™¤å¤–: `*.small.test.ts`ã€`*.dummy.ts`

#### å…¥åŠ›

```json
{
  "targetFilePaths": [
    "/path/to/server/src/domain/model/todo/todo.ts",
    "/path/to/server/src/domain/model/todo/todo-repository.ts"
  ]
}
```

#### å‡¦ç†ãƒ•ãƒ­ãƒ¼

1. **å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸¦åˆ—å‡¦ç†**ï¼ˆPromise.allï¼‰
   - ãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥åˆ¤å®šï¼ˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ / ãƒªãƒã‚¸ãƒˆãƒªï¼‰
   - ãƒãƒªã‚·ãƒ¼é¸æŠãƒ»ä¸¦åˆ—èª­ã¿è¾¼ã¿
   - Claude APIã§ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ
2. **çµæœã‚’é›†ç´„**ã—ã¦è¿”ã™

#### å‡ºåŠ›ä¾‹

```markdown
# ğŸ“ ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ãƒ¬ãƒ“ãƒ¥ãƒ¼

## ã‚µãƒãƒªãƒ¼

- ç·ãƒ•ã‚¡ã‚¤ãƒ«æ•°: 2
- æˆåŠŸ: 2
- å¤±æ•—: 0

---

## todo.ts

### é©ç”¨ã•ã‚ŒãŸãƒãƒªã‚·ãƒ¼

- 10-domain-model-overview.md
- 20-entity-design.md
- 40-aggregate-pattern.md

### ãƒ¬ãƒ“ãƒ¥ãƒ¼

[Claudeã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹]
...
```

## ãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥ã¨ãƒãƒªã‚·ãƒ¼ã®å¯¾å¿œ

### Web ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ï¼ˆ`review_web_tests`ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥    | é¸æŠã•ã‚Œã‚‹ãƒãƒªã‚·ãƒ¼ï¼ˆä¸¦åˆ—èª­ã¿è¾¼ã¿ï¼‰                                        |
| --------------- | ------------------------------------------------------------------------- |
| `*.ct.test.tsx` | `10-test-strategy-overview.md` + `20-component-test.md`                   |
| `*.ss.test.ts`  | `10-test-strategy-overview.md` + `30-snapshot-test.md`                    |
| ã‚«ãƒãƒ¬ãƒƒã‚¸      | `00-test-coverage-requirements.md`ï¼ˆãƒšãƒ¼ã‚¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã”ã¨ã«1å›ãƒã‚§ãƒƒã‚¯ï¼‰ |

### ã‚µãƒ¼ãƒãƒ¼ ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ï¼ˆ`review_domain_models`ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥                    | é¸æŠã•ã‚Œã‚‹ãƒãƒªã‚·ãƒ¼ï¼ˆä¸¦åˆ—èª­ã¿è¾¼ã¿ï¼‰                                                       |
| ------------------------------- | ---------------------------------------------------------------------------------------- |
| ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆ`*.ts`ï¼‰          | `10-domain-model-overview.md` + `20-entity-design.md` + `40-aggregate-pattern.md`        |
| ãƒªãƒã‚¸ãƒˆãƒªï¼ˆ`*-repository.ts`ï¼‰ | `10-domain-model-overview.md` + `30-repository-interface.md` + `40-aggregate-pattern.md` |

**é‡è¦**:

- å„ãƒ„ãƒ¼ãƒ«ã¯å¯¾å¿œã™ã‚‹policyãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸¦åˆ—ã§èª­ã¿è¾¼ã¿ã¾ã™
- å„ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥ã«å¿œã˜ã¦å€‹åˆ¥ã«ãƒãƒªã‚·ãƒ¼ã‚’é¸æŠã•ã‚Œã¾ã™

## ä½¿ç”¨ä¾‹

### Claude Code ã§ã®ä½¿ç”¨

Claude Codeã‹ã‚‰MCPãƒ„ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã—ã¦ã€ä½œæˆãƒ»ä¿®æ­£ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¾ã™ã€‚

```typescript
// ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼
await mcp__guardrails__review_web_tests({
  targetFilePaths: [
    "/path/to/TodoForm.ct.test.tsx",
    "/path/to/TodoCard.ct.test.tsx",
  ],
});

// ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼
await mcp__guardrails__review_domain_models({
  targetFilePaths: [
    "/path/to/server/src/domain/model/todo/todo.ts",
    "/path/to/server/src/domain/model/todo/todo-repository.ts",
  ],
});
```

## æ‹¡å¼µæ–¹æ³•

### æ–°ã—ã„ãƒãƒªã‚·ãƒ¼ã®è¿½åŠ 

1. `policy/{layer}/{category}/` ã«æ–°ã—ã„ãƒãƒªã‚·ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ï¼ˆä¾‹: `50-xxx.md`ï¼‰
2. `review/{layer}/{category}/` ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›´æ–°

### æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã®ã‚µãƒãƒ¼ãƒˆ

`review/{layer}/{category}/*-reviewer.ts` ã® `selectPolicies()` é–¢æ•°ã«æ¡ä»¶ã‚’è¿½åŠ ï¼š

```typescript
if (fileName.endsWith(".new-type.ts")) {
  policyFiles = [
    path.join(policyBase, "10-overview.md"),
    path.join(policyBase, "50-new-policy.md"),
  ];
}
```

### æ–°ã—ã„ãƒ¬ã‚¤ãƒ¤ãƒ¼/ã‚«ãƒ†ã‚´ãƒªã®è¿½åŠ 

```
policy/
â”œâ”€â”€ web/
â”‚   â””â”€â”€ test-strategy/
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ domain-model/        # å®Ÿè£…æ¸ˆã¿
â”‚   â””â”€â”€ use-case/            # â† æ–°ã‚«ãƒ†ã‚´ãƒª
â””â”€â”€ infra/
    â””â”€â”€ terraform/           # â† æ–°ãƒ¬ã‚¤ãƒ¤ãƒ¼

review/
â”œâ”€â”€ web/
â”‚   â””â”€â”€ test-strategy/
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ domain-model/        # å®Ÿè£…æ¸ˆã¿
â”‚   â””â”€â”€ use-case/            # â† å¯¾å¿œã™ã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè£…
â”‚       â””â”€â”€ index.ts
â””â”€â”€ infra/
    â””â”€â”€ terraform/
        â””â”€â”€ index.ts
```

å®Ÿè£…å¾Œã€`guardrails/index.ts` ã«MCPãƒ„ãƒ¼ãƒ«ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

## é–‹ç™º

```bash
# é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ“ãƒ«ãƒ‰ + å®Ÿè¡Œï¼‰
npm run dev

# ãƒ“ãƒ«ãƒ‰ã®ã¿
npm run build

# å®Ÿè¡Œã®ã¿
npm start
```

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ãƒã‚¤ãƒ³ãƒˆ

1. **ä¸¦åˆ—å‡¦ç†**
   - ãƒãƒªã‚·ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿: Promise.all
   - è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼: Promise.all

2. **ãƒãƒªã‚·ãƒ¼é¸æŠã®è‡ªå‹•åŒ–**
   - ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã‹ã‚‰ãƒãƒªã‚·ãƒ¼ã‚’è‡ªå‹•é¸æŠ
   - é©åˆ‡ãªãƒãƒªã‚·ãƒ¼ã®ã¿ã‚’èª­ã¿è¾¼ã¿

3. **Claude Agent SDKçµ±åˆ**
   - MCPãƒ„ãƒ¼ãƒ«å†…ã§Claude APIã‚’ç›´æ¥å‘¼ã³å‡ºã—
   - ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’è‡ªå‹•ã§é›†ç´„
