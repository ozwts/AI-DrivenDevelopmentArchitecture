# E2Eテストワークフロー

## タスク計画ガイド

このフェーズで作成する成果物と、タスク分割の指針。

### 主要成果物

| 成果物 | 実装先 | 粒度 |
|--------|--------|------|
| Page Object | `e2e/pages/{page}.page.ts` | ページごとに1タスク（必要な場合） |
| テストケース | `e2e/tests/{feature}.spec.ts` | 機能ごとに1タスク |
| E2Eレビュー | - | 全テストをまとめて1タスク |
| ローカルE2E実行 | - | 1タスク |
| テスト修復 | - | 失敗時のみ |

### タスク分割ルール

1. **Page Object → テストケース** の順序を守る
2. **機能単位で分割**: 認証フロー、CRUD操作、検索機能は別タスク
3. **ローカルで完結**: ブランチ環境E2EはCIに任せる
4. **必須の終了タスク**: 「コミット・プッシュ・PR更新」「PRをReady for Reviewに変更」を最後に追加

### タスク例（Project機能のE2Eテストを追加する場合）

```
1. e2e/pages/project-list.page.ts を作成
2. e2e/pages/project-detail.page.ts を作成
3. Page Objectをレビュー
4. e2e/tests/project-crud.spec.ts を作成
5. テストケースをレビュー
6. ローカルE2Eテストを実行
7. （失敗時）テストを修復
8. E2Eフェーズの成果物をコミット・プッシュ・PR更新
9. PRをReady for Reviewに変更
```

### タスク例（テスト追加不要の場合）

```
1. E2Eテスト追加不要を確認（既存テストでカバー済み）
2. 既存E2Eテストを実行して回帰がないことを確認
3. E2Eフェーズの成果物をコミット・プッシュ・PR更新
4. PRをReady for Reviewに変更
```

---

## 対象スコープ

- `e2e/` - E2Eテストコード

## 開発モード

```
mcp__guardrails__procedure_dev(action='start', mode='full')
```

**注意**: E2Eテストは `full` モードで実行。`mock` モードでは実行不可。

---

## ステップ 0: 要件定義と設計方針の確認

**読むもの:**

- `contracts/business/` - ビジネス契約（テスト対象のユースケース）
- `guardrails/policy/e2e/playwright/` - E2Eポリシー

---

## ステップ 1: Page Objectの実装（必要な場合）

**ポリシー:** `guardrails/policy/e2e/playwright/20-page-object-pattern.md`

**実装先:** `e2e/pages/`

**作成するもの:**

- `{page-name}.page.ts` - Page Objectクラス

**完了条件:** 静的解析パス、定性レビューパス、コミット

---

## ステップ 2: テストケースの実装

**ポリシー:** `guardrails/policy/e2e/playwright/30-test-patterns.md`

**実装先:** `e2e/tests/`

**作成するもの:**

- `{feature}.spec.ts` - テストファイル

**完了条件:** 静的解析パス、定性レビューパス、コミット

---

## ステップ 3: 認証の設定（必要な場合）

**ポリシー:** `guardrails/policy/e2e/playwright/40-authentication.md`

**確認すること:**

- 認証が必要なテストかどうか
- 認証状態の保存・復元が正しく設定されているか

**完了条件:** 認証設定確認

---

## ステップ 4: ローカルE2Eテスト実行

```
mcp__guardrails__procedure_test(target='e2e')
```

**特定ファイルのみ実行:**

```
mcp__guardrails__procedure_test(
  target='e2e',
  file='e2e/tests/{feature}.spec.ts'
)
```

**完了条件:** テスト成功

---

## ステップ 5: テスト失敗時の修復

**ポリシー:** `guardrails/policy/e2e/playwright/50-test-repair.md`

→ ポリシーに従って修復

**レビュー後にテスト再実行:**

```
mcp__guardrails__procedure_test(target='e2e')
```

**完了条件:** 静的解析パス、定性レビューパス、テスト成功

---

## ステップ 6: 最終検証

```
mcp__guardrails__procedure_test(target='e2e')
```

今回実装した箇所に関わる全ての観点で定性レビューを実施する（並列実行可能）。

**完了条件:** 全テスト成功、全レビューパス

---

## ブランチ環境でのE2Eテスト（参考）

**注意: ブランチ環境でのE2Eテストは CI/CD パイプラインで自動実行されます。**
**ローカル開発時は、ローカルE2Eテストのみ実施すれば十分です。**

以下は参考情報として、手動実行が必要な場合の手順を記載します。

### ブランチ環境のデプロイ

初回:
```
mcp__guardrails__procedure_deploy_dev(
  action='deploy',
  useBranchEnv=true,
  initialDeploy=true
)
```

### Cognitoテストユーザー作成

```
mcp__guardrails__procedure_e2e_setup(
  action='user-setup',
  useBranchEnv=true
)
```

### E2Eテスト実行

```
mcp__guardrails__procedure_test(
  target='e2e',
  baseUrl='https://xxx.cloudfront.net',
  apiBaseUrl='https://xxx.execute-api.ap-northeast-1.amazonaws.com'
)
```

### クリーンアップ

```
mcp__guardrails__procedure_e2e_setup(
  action='user-destroy',
  useBranchEnv=true
)

mcp__guardrails__procedure_deploy_dev(
  action='destroy',
  useBranchEnv=true
)
```

---

## ステップ 7: コミット＆PR更新

### 1. リモート同期

```bash
git fetch origin && git rebase origin/{current-branch}
```

### 2. コミット＆プッシュ

```bash
git add -A
git commit -m "test(e2e): {message}"
git push origin {current-branch}
```

### 3. PR更新（全タスク完了）

GitHub MCPサーバーでPRボディを最終更新（`.github/PULL_REQUEST_TEMPLATE.md` に従う）：

- 全タスクにチェックを入れる
- 見直し結果を反映（タスクの追加・削除・修正）
- 特記事項を追記（必要な場合）

**完了条件:** コミット成功、プッシュ成功、PR更新完了（進捗＆計画変更を反映）

---

## ステップ 8: PRをReady for Reviewに変更

全フェーズ完了後、Draft PRを通常のPRに変更：

```
mcp__github__update_pull_request(
  owner='{owner}',
  repo='{repo}',
  pullNumber={PR番号},
  draft=false
)
```

**完了条件:** Draft PRがReady for Reviewに変更

---

## 完了条件

- ローカルE2Eテスト成功
- 主要ユーザーフローが動作確認済み
- ポリシーレビュー通過
- ブランチ環境E2EテストはCIで自動実行（手動実行不要）
- Draft PRがReady for Reviewに変更
