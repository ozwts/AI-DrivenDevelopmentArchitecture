# E2Eテストワークフロー

## 対象スコープ

- `e2e/` - E2Eテストコード

## 開発モード

```
mcp__guardrails__procedure_dev(action='start', mode='full')
```

**注意**: E2Eテストは `full` モードで実行。`mock` モードでは実行不可。

---

## ステップ 0: 要件定義と設計方針の確認

**読むもの:**

- `contracts/business/` - ビジネス契約（テスト対象のユースケース）
- `guardrails/policy/e2e/playwright/` - E2Eポリシー

---

## ステップ 1: Page Objectの実装（必要な場合）

**ポリシー:** `guardrails/policy/e2e/playwright/20-page-object-pattern.md`

**実装先:** `e2e/pages/`

**作成するもの:**

- `{page-name}.page.ts` - Page Objectクラス

---

## ステップ 2: テストケースの実装

**ポリシー:** `guardrails/policy/e2e/playwright/30-test-patterns.md`

**実装先:** `e2e/tests/`

**作成するもの:**

- `{feature}.spec.ts` - テストファイル

---

## ステップ 3: 認証の設定（必要な場合）

**ポリシー:** `guardrails/policy/e2e/playwright/40-authentication.md`

**確認すること:**

- 認証が必要なテストかどうか
- 認証状態の保存・復元が正しく設定されているか

---

## ステップ 4: レビュー

→ `10-development-overview.md` の「レビューと修正」を参照

### 4-1: 静的解析

```
mcp__guardrails__review_static_analysis(
  workspace='web',
  targetDirectories=['e2e/']
)
```

### 4-2: 定性レビュー

修正内容に応じた観点でポリシーレビューを実施する。

```
mcp__guardrails__review_qualitative(
  policyId='{修正内容に応じたポリシーID}',
  targetDirectories=['{実装先ディレクトリ}']
)
```

---

## ステップ 5: ローカルE2Eテスト実行

```
mcp__guardrails__procedure_test(target='e2e')
```

**特定ファイルのみ実行:**

```
mcp__guardrails__procedure_test(
  target='e2e',
  file='e2e/tests/{feature}.spec.ts'
)
```

---

## ステップ 6: テスト失敗時の修復

**ポリシー:** `guardrails/policy/e2e/playwright/50-test-repair.md`

→ ポリシーに従って修復

---

## ステップ 7: 最終検証

```
mcp__guardrails__procedure_test(target='e2e')
```

今回実装した箇所に関わる全ての観点で定性レビューを実施する。

---

## ブランチ環境でのE2Eテスト（参考）

**注意: ブランチ環境でのE2Eテストは CI/CD パイプラインで自動実行されます。**
**ローカル開発時は、ローカルE2Eテストのみ実施すれば十分です。**

以下は参考情報として、手動実行が必要な場合の手順を記載します。

### ブランチ環境のデプロイ

初回:
```
mcp__guardrails__procedure_deploy_dev(
  action='deploy',
  useBranchEnv=true,
  initialDeploy=true
)
```

### Cognitoテストユーザー作成

```
mcp__guardrails__procedure_e2e_setup(
  action='user-setup',
  useBranchEnv=true
)
```

### E2Eテスト実行

```
mcp__guardrails__procedure_test(
  target='e2e',
  baseUrl='https://xxx.cloudfront.net',
  apiBaseUrl='https://xxx.execute-api.ap-northeast-1.amazonaws.com'
)
```

### クリーンアップ

```
mcp__guardrails__procedure_e2e_setup(
  action='user-destroy',
  useBranchEnv=true
)

mcp__guardrails__procedure_deploy_dev(
  action='destroy',
  useBranchEnv=true
)
```

---

## 完了条件

- ローカルE2Eテストが成功
- 主要ユーザーフローが動作確認済み
- ポリシーレビューを通過
- ブランチ環境E2EテストはCIで自動実行（手動実行不要）
