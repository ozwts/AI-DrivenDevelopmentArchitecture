# E2Eテスト

Playwrightによるエンドツーエンドテストのワークフロー。

## 目的

- フロントエンドとサーバーの統合検証
- ユーザー操作フローの動作確認
- 本番に近い環境での検証

---

## ローカルE2Eテスト

### 開発サーバー起動

```
mcp__guardrails__procedure_dev(action='start', mode='full')
```

**注意**: E2Eテストは `full` モードで実行。`mock` モードでは実行不可。

### テスト実行

```
mcp__guardrails__procedure_test(target='e2e')
```

### 特定ファイルのみ実行

```
mcp__guardrails__procedure_test(
  target='e2e',
  file='e2e/tests/todo.spec.ts'
)
```

---

## ブランチ環境でのE2Eテスト

本番に近い環境（AWS）でのテスト。

### 1. ブランチ環境のデプロイ

初回:
```
mcp__guardrails__procedure_deploy_dev(
  action='deploy',
  useBranchEnv=true,
  initialDeploy=true
)
```

更新時:
```
mcp__guardrails__procedure_deploy_dev(
  action='deploy',
  useBranchEnv=true,
  target='all'
)
```

### 2. Cognitoテストユーザー作成

```
mcp__guardrails__procedure_e2e_setup(
  action='user-setup',
  useBranchEnv=true
)
```

### 3. E2Eテスト実行

```
mcp__guardrails__procedure_test(
  target='e2e',
  baseUrl='https://xxx.cloudfront.net',
  apiBaseUrl='https://xxx.execute-api.ap-northeast-1.amazonaws.com'
)
```

### 4. クリーンアップ

テストユーザー削除:
```
mcp__guardrails__procedure_e2e_setup(
  action='user-destroy',
  useBranchEnv=true
)
```

ブランチ環境破棄:
```
mcp__guardrails__procedure_deploy_dev(
  action='destroy',
  useBranchEnv=true
)
```

---

## テスト作成

**ポリシー:** `guardrails/policy/e2e/playwright/`

- `10-playwright-overview.md` - 全体方針
- `20-page-object-pattern.md` - Page Objectパターン
- `30-test-patterns.md` - テストパターン
- `40-authentication.md` - 認証
- `50-test-repair.md` - テスト修復

→ ポリシーに則ってテストを実装

### ポリシーレビュー

```
mcp__guardrails__review_qualitative(
  policyId='e2e/playwright',
  targetDirectories=['e2e/tests/']
)
```

### テスト構造

```
e2e/
├── tests/           # テストファイル
│   ├── auth.spec.ts
│   ├── todo.spec.ts
│   └── project.spec.ts
├── pages/           # Page Object
└── fixtures/        # テストデータ
```

---

## テスト失敗時の対応

### デバッグ

```
mcp__guardrails__procedure_test(
  target='e2e',
  file='e2e/tests/failing.spec.ts'
)
```

### よくある原因

1. **タイミング問題**: 要素の待機不足
2. **セレクタ変更**: UI変更によるセレクタ不一致
3. **データ依存**: テストデータの不整合
4. **認証問題**: トークン期限切れ

### 修復フロー

1. 失敗原因を特定
2. テストまたはアプリを修正
3. 再実行で確認

---

## 完了条件

- ローカルE2Eテストが成功
- ブランチ環境E2Eテストが成功（必要な場合）
- 主要ユーザーフローが動作確認済み
