# E2Eテストワークフロー

サブエージェント（e2e-test-planner, e2e-test-generator, e2e-test-healer）を活用してE2Eテストを作成・実行する。

## タスク計画ガイド

このフェーズで作成する成果物と、タスク分割の指針。

### 主要成果物

| 成果物 | 実装先 | 粒度 |
|--------|--------|------|
| テスト計画 | `e2e/plans/{feature}.plan.md` | 機能ごとに1タスク |
| Page Object | `e2e/pages/{page}.page.ts` | ページごとに1タスク（必要な場合） |
| テストケース | `e2e/tests/{feature}.spec.ts` | 機能ごとに1タスク |
| テスト修復 | - | 失敗時のみ |

### タスク分割ルール

1. **計画 → 生成 → 実行 → 修復** の順序を守る
2. **サブエージェントを活用**: 各ステップで専用エージェントを使用
3. **ローカルで完結**: ブランチ環境E2EはCIに任せる
4. **必須の終了タスク**: 「コミット・プッシュ・PR更新」「PRをReady for Reviewに変更」を最後に追加

### タスク例（Project機能のE2Eテストを追加する場合）

```
1. Project機能のテスト計画を作成（e2e-test-planner）
2. テストコードを生成（e2e-test-generator）
3. ローカルE2Eテストを実行
4. （失敗時）テストを修復（e2e-test-healer）
5. E2Eフェーズの成果物をコミット・プッシュ・PR更新
6. PRをReady for Reviewに変更
```

### タスク例（テスト追加不要の場合）

```
1. E2Eテスト追加不要を確認（既存テストでカバー済み）
2. 既存E2Eテストを実行して回帰がないことを確認
3. E2Eフェーズの成果物をコミット・プッシュ・PR更新
4. PRをReady for Reviewに変更
```

---

## 前提条件

**E2Eフェーズ開始前に、Final Reviewフェーズが完了していること。**

→ `procedure/workflow/runbooks/80-final-review.md` 参照

---

## 対象スコープ

- `e2e/` - E2Eテストコード

## 開発モード

```
mcp__guardrails__procedure_dev(action='start', mode='full')
```

**注意**: E2Eテストは `full` モードで実行。`mock` モードでは実行不可。

---

## ステップ 1: テスト計画の作成

**サブエージェント:** `e2e-test-planner`

```
Task(
  subagent_type='e2e-test-planner',
  prompt='{機能名}のE2Eテスト計画を作成してください。
  対象シナリオ: contracts/business/{domain}/scenario/ を参照
  出力先: e2e/plans/{feature}.plan.md'
)
```

**plannerの動作:**

1. 憲法・ポリシー・ビジネス仕様を読み込み
2. `planner_setup_page` でページをセットアップ
3. ブラウザ操作でUIを探索
4. テスト計画を設計
5. `planner_save_plan` で計画を保存

**完了条件:** `e2e/plans/{feature}.plan.md` が作成される

---

## ステップ 2: テストコードの生成

**サブエージェント:** `e2e-test-generator`

```
Task(
  subagent_type='e2e-test-generator',
  prompt='以下のテスト計画からテストコードを生成してください。
  テスト計画: e2e/plans/{feature}.plan.md
  出力先: e2e/tests/{feature}/'
)
```

**generatorの動作:**

1. 憲法・ポリシーを読み込み
2. テスト計画を読み込み
3. `generator_setup_page` でページをセットアップ
4. 各ステップをブラウザで実行・検証
5. `generator_read_log` でログ取得
6. Page Objectを必要に応じて拡張
7. `generator_write_test` でテストコード出力

**完了条件:** `e2e/tests/{feature}/*.spec.ts` が作成される

---

## ステップ 3: ローカルE2Eテスト実行

```
mcp__guardrails__procedure_test(target='e2e')
```

**特定ファイルのみ実行:**

```
mcp__guardrails__procedure_test(
  target='e2e',
  file='e2e/tests/{feature}.spec.ts'
)
```

**完了条件:** テスト成功

---

## ステップ 4: テスト失敗時の修復

**サブエージェント:** `e2e-test-healer`

```
Task(
  subagent_type='e2e-test-healer',
  prompt='失敗したE2Eテストを修復してください。
  テストファイル: e2e/tests/{feature}.spec.ts'
)
```

**healerの動作:**

1. 憲法・ポリシーを読み込み（特に`50-test-repair.md`）
2. `test_run` でテスト実行・失敗特定
3. `test_debug` で失敗テストをデバッグ
4. `browser_snapshot`, `browser_console_messages`, `browser_network_requests` で調査
5. サーバーログ確認（`procedure_dev(action='logs')`）
6. 修正対象を判断・修正
7. 再テストでパスするまで繰り返し

**完了条件:** 静的解析パス、テスト成功

---

## ステップ 5: 最終検証

```
mcp__guardrails__procedure_test(target='e2e')
```

**完了条件:** 全テスト成功

---

## ブランチ環境でのE2Eテスト（参考）

**注意: ブランチ環境でのE2Eテストは CI/CD パイプラインで自動実行されます。**
**ローカル開発時は、ローカルE2Eテストのみ実施すれば十分です。**

以下は参考情報として、手動実行が必要な場合の手順を記載します。

### ブランチ環境のデプロイ

初回:
```
mcp__guardrails__procedure_deploy_dev(
  action='deploy',
  useBranchEnv=true,
  initialDeploy=true
)
```

### Cognitoテストユーザー作成

```
mcp__guardrails__procedure_e2e_setup(
  action='user-setup',
  useBranchEnv=true
)
```

### E2Eテスト実行

```
mcp__guardrails__procedure_test(
  target='e2e',
  baseUrl='https://xxx.cloudfront.net',
  apiBaseUrl='https://xxx.execute-api.ap-northeast-1.amazonaws.com'
)
```

### クリーンアップ

```
mcp__guardrails__procedure_e2e_setup(
  action='user-destroy',
  useBranchEnv=true
)

mcp__guardrails__procedure_deploy_dev(
  action='destroy',
  useBranchEnv=true
)
```

---

## ステップ 6: コミット＆PR更新

### 1. リモート同期

```bash
git fetch origin && git rebase origin/{current-branch}
```

### 2. コミット＆プッシュ

```bash
git add -A
git commit -m "test(e2e): {message}"
git push origin {current-branch}
```

### 3. PR更新（全タスク完了）

GitHub MCPサーバーでPRボディを最終更新（`.github/PULL_REQUEST_TEMPLATE.md` に従う）：

- 全タスクにチェックを入れる
- 見直し結果を反映（タスクの追加・削除・修正）
- 特記事項を追記（必要な場合）

**完了条件:** コミット成功、プッシュ成功、PR更新完了

---

## ステップ 7: PRをReady for Reviewに変更

全フェーズ完了後、Draft PRを通常のPRに変更：

```
mcp__github__update_pull_request(
  owner='{owner}',
  repo='{repo}',
  pullNumber={PR番号},
  draft=false
)
```

**完了条件:** Draft PRがReady for Reviewに変更

---

## 完了条件

- ローカルE2Eテスト成功
- 主要ユーザーフローが動作確認済み
- ブランチ環境E2EテストはCIで自動実行（手動実行不要）
- Draft PRがReady for Reviewに変更

**前提:** Final Reviewフェーズ（`80-final-review.md`）が完了済みであること
