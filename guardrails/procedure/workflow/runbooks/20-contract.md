# 契約定義ワークフロー

## 対象スコープ

- `contracts/business/` - ビジネス契約
- `contracts/api/` - API契約（OpenAPI）

---

## ステップ 0: 要件定義の確認

**読むもの:**

- `contracts/business/glossary.md` - 用語集
- `contracts/business/` - 既存ビジネス契約
- `contracts/api/` - 既存API契約

---

## ステップ 1: ビジネス契約の定義

**ポリシー:** `guardrails/policy/contract/business/`

**実装先:** `contracts/business/{domain}/`

**作成するもの:**

- `definition.md` - エンティティ定義（属性、制約）
- `scenario/{action}.md` - ユースケースシナリオ

**用語集の更新:**

新しいドメイン用語がある場合は `contracts/business/glossary.md` を更新

**影響分析:**

定義変更時は `30-definition.md` の影響分析ガイドラインに従い、同一ドメインとクロスドメインの影響を確認する。

**完了条件:** 定性レビューパス、影響分析完了、コミット

---

## ステップ 1.5: 要件の曖昧性検出時の再ヒアリング

**影響分析中に要件の曖昧性を検出した場合、実装を中断してユーザーに確認する。**

### 再ヒアリングが必要なケース

| 検出状況 | 例 |
|---------|-----|
| クロスドメイン影響の要件不明 | 「TODOの担当者はプロジェクトメンバーに限定すべきか？」 |
| 制約の適用範囲が曖昧 | 「この制約はすべてのケースに適用するか、特定条件のみか？」 |
| 複数の解釈が可能 | 「メンバー削除時、担当TODOはどうなるべきか？」 |

### 再ヒアリングのフロー

```
1. 曖昧性を検出
   ↓
2. 実装を一時中断
   ↓
3. AskUserQuestionツールで確認
   - 発見した曖昧性を説明
   - 選択肢を提示（推奨オプションを明示）
   ↓
4. ユーザー回答を受けて要件を更新
   - procedure_workflow(action='requirements', ...) で要件追加
   ↓
5. 必要に応じてタスク計画を見直し
   - procedure_workflow(action='set', tasks=[...])
   ↓
6. 実装を再開
```

### 質問のフォーマット例

```
影響分析中に要件の確認が必要な点が見つかりました。

## 検出した曖昧性

プロジェクトに「プロジェクトメンバー」を追加しましたが、
TODOドメインへの影響について要件が明確ではありません。

## 確認したいこと

プロジェクトに所属するTODOの担当者は、
プロジェクトメンバーに限定すべきですか？

## 選択肢

1. **限定する（推奨）** - 担当者はプロジェクトメンバーから選択
2. **限定しない** - 任意のユーザーを担当者に設定可能
3. **その他** - 別の要件がある場合
```

### 原則

- **推測で実装しない**: 曖昧なまま進めると手戻りが大きくなる
- **選択肢を提示**: 自由記述より選択式で確認を効率化
- **推奨を明示**: 技術的観点から推奨オプションを提案

---

## ステップ 2: API契約の定義

**ポリシー:** `guardrails/policy/contract/api/`

**実装先:** `contracts/api/`

**作成するもの:**

- `{app-name}/{aggregate}/{entity}.schemas.yaml` - スキーマ定義
- `{app-name}/{aggregate}/{entity}.paths.yaml` - エンドポイント定義
- `{app-name}/{app-name}.entry.yaml` への参照追加

**完了条件:** 静的解析パス、定性レビューパス、コミット

---

## ステップ 3: コード生成

```
mcp__guardrails__procedure_codegen(workspace='all')
```

---

## 契約修正について

フロントエンド実装中の契約修正は許容される。

**修正フロー:**

1. OpenAPI仕様を修正
2. コード再生成
3. 影響箇所を修正
4. 実装を継続

**注意**: サーバー実装開始後の契約修正は影響範囲が大きいため慎重に。

---

## ステップ 4: フェーズ完了チェックポイント

このフェーズで得られた知見を踏まえ、後続タスクの計画を見直す。

**確認すること:**

1. レビューで指摘された設計変更の影響（集約設計、エンティティ構造など）
2. 当初の想定と異なる契約設計
3. 追加で必要になったタスク
4. 不要になったタスク

**見直しが必要な場合:**

```
mcp__guardrails__procedure_workflow(action='list')  // 現在の状態を確認
mcp__guardrails__procedure_workflow(action='set', tasks=[
  // 完了済みタスクはdone: trueで保持
  { what: "完了済みタスク", ..., done: true },
  // 新しい計画
  { what: "新タスク", ... }
])
```

**見直し不要の場合:** そのまま次フェーズへ進む

---

## ステップ 5: コミット＆PR更新

### 1. リモート同期

```bash
git fetch origin && git rebase origin/{current-branch}
```

### 2. コミット＆プッシュ

```bash
git add -A
git commit -m "contract({scope}): {message}"
git push origin {current-branch}
```

### 3. PR更新

GitHub MCPサーバーでPRボディを更新（`.github/PULL_REQUEST_TEMPLATE.md` に従う）：

- 完了タスクにチェックを入れる
- 見直し結果を反映（タスクの追加・削除・修正）
- 特記事項を追記（必要な場合）

**完了条件:** コミット成功、プッシュ成功、PR更新完了（進捗＆計画変更を反映）

---

## 完了条件

- ビジネス契約定義完了
- API契約定義完了
- コード生成完了
- ポリシーレビュー通過
