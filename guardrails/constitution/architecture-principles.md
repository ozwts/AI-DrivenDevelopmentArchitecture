# アーキテクチャ原則

## 最高原則

システムアーキテクチャは**境界により並行開発を実現（Boundary-Driven Development）**しなければならない。

- **レイヤーの分離**: ビジネスロジックと技術詳細を完全分離し、変更を局所化
- **依存の制御**: 技術的概念をビジネスロジックから排除し、技術選択の自由を保つ
- **型による契約**: 単一の真実の源から型を生成し、実装の一貫性を保証
- **モジュールの独立**: Server・Web・Infraが型契約で結ばれ、並行開発可能

## 理念

### アーキテクチャの本質

アーキテクチャとは、**一貫したパターン**により**AIが設計意図を推論可能**にし、**明確な境界**により**複数AIの並行作業**を実現し、**技術と業務の分離**により**人間の変更を容易**にすることである。

### 得られるベネフィット

**AIの自律開発速度の最大化**:
- 一貫したレイヤー・パターンによりAIが既存コードから設計意図を推論し、迷わず実装できる
- 型定義が制約として機能し、誤った実装を事前に回避できる
- インターフェースが先行定義されれば、AIが並行着手して開発速度を線形にスケールできる

**人間による変更容易性の担保**:
- ビジネスロジックが技術詳細から完全分離され、ドメイン知識だけで理解・変更可能
- 型エラーが変更の影響範囲を即座に明示し、予期しない副作用を防止
- レイヤー間の変更が波及せず、安全に修正できる

**長期的な保守性の確保**:
- 技術的負債が特定レイヤー・モジュールに局所化され、計画的に返済可能
- インフラ・フレームワーク変更がビジネスロジックに影響せず、技術移行が容易
- アーキテクチャパターンを一度学べば全モジュールに適用でき、属人性を排除

## 制度：三権分立による実現

### Policy（立法）

アーキテクチャの基本ルールを定義する。

#### レイヤー分離の原則

**4層構造**: Domain（業務ルール）、UseCase（アプリケーションロジック）、Infrastructure（技術実装）、Handler（外部境界）を明確に分離

**依存の方向**: 外側のレイヤーが内側に依存、内側は外側を知らない（Domain ← UseCase ← Infrastructure ← Handler）

**技術概念の排除**: Domainに技術用語（AWS・データベース・フレームワーク名）を一切含めず、抽象的な概念のみ使用

#### 型契約の原則

**OpenAPI-First**: API仕様をOpenAPIで定義し、Server・WebのZodスキーマを自動生成して型安全性を保証

**Result型**: 例外を値として扱い、成功・失敗を型レベルで表現してエラーハンドリング漏れを防止

**Immutability**: readonly修飾子で不変性を保証し、更新メソッドは新インスタンスを返す

#### モノレポ構成の原則

**Server・Web・Infraの分離**: 各モジュールが独立して開発可能、OpenAPIで型契約を結ぶ

**Infrastructure as Code**: インフラをコードで管理し、環境を物理分離して誤操作を防止

### Procedure（行政）

アーキテクチャを実装し、**AIの並行開発を加速**しつつ、**人間が変更しやすい状態**を維持する。

#### 実装順序

**インターフェース先行**: Domainにインターフェースを定義し、UseCaseとInfrastructureを並行着手

**型生成の自動化**: OpenAPIからZodスキーマを生成し、Server・Webで共通の型契約を利用

**Page-Specific分離**: Webのコンポーネントはページ配下に配置し、複数ページで使用時のみ共有化

### Review（司法）

アーキテクチャの適切性を審査する。

#### 審査項目

**レイヤー境界の遵守**: Domainに技術的概念が含まれていないか、依存の方向が正しいか

**型安全性の確保**: OpenAPI生成型の使用、Result型によるエラーハンドリング、readonly修飾子の適用

**並行開発可能性**: レイヤー・ページ単位で独立しているか、長大なファイルが存在しないか

#### 実施方法

**自動レビュー**: 型エラー検出、依存関係チェック（レイヤー違反の検出）

**手動レビュー**: PRレビュー時にアーキテクチャパターンの一貫性を確認

## 原則の適用

### レイヤー分離

Domainに技術用語を一切含めず、インターフェース駆動でUseCaseとInfrastructureを分離

### 型契約

OpenAPIを単一の真実の源とし、Server・WebのZodスキーマを自動生成

### 並行開発

インターフェース先行定義、レイヤー別分担、Page-Specificコンポーネント分離でコンフリクトを最小化
