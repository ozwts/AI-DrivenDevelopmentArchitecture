# 可観測性原則

## 最高原則

システムは**可観測（Observable）**でなければならない。

- **実装が理解可能**: コード・アーキテクチャ・設計意図が明文化され、AIと人間が理解できる
- **動作が追跡可能**: システムの実行時の動作・状態変化が記録され、問題箇所を迅速に特定できる
- **意思決定が透明**: なぜその実装になったのか、変更履歴・理由が追跡可能

## 理念

### 可観測性の本質

可観測性とは、システムの**静的な構造（What/Why）**と**動的な動作（How/When）**の両方を、AIと人間が理解できる状態に保つことである。

**静的可観測性（実装の理解）**:
- コード自体が意図を表現し、なぜその実装なのかが明文化されている
- アーキテクチャ・設計判断・制約が文書化され、属人性を排除
- AIがコードベースを読み解き、自律的に変更・拡張できる

**動的可観測性（実行の追跡）**:
- システムの動作・状態変化が構造化ログとして記録される
- AIが実行履歴から異常検知・診断・修正案提示を実現
- 人間が監査証跡から責任の所在を検証できる

### 得られるベネフィット

**AIの自律開発速度の最大化**:
- AIがコードと実行履歴から現状を把握し、問題を自己解決できる
- エラーの原因特定から修正案提示までの時間を最小化し、開発イテレーションを高速化
- 人間の介入なしに問題を診断・解決し、開発を継続できる

**人間によるシステム責任の担保**:
- 実装の意図・設計判断が明文化され、誰でも理解できる（属人性の排除）
- システムの動作履歴が保持され、AIの判断・実行を事後検証できる
- 監査証跡により、問題発生時の責任の所在を明確化できる

**継続的な品質向上**:
- 問題の早期発見と迅速な解決により、システムの信頼性が向上
- ログから傾向を分析し、潜在的な問題を予防できる
- アーキテクチャの進化・技術的負債の返済を計画的に実施できる

## 制度：三権分立による実現

### Policy（立法）

可観測性を実現するためのルールを定義する。

#### 静的可観測性のルール

**コードの自己文書化**:
- 型定義・インターフェースで意図を明示
- 複雑なロジックには「なぜ」を説明するコメント
- アーキテクチャパターン（Clean Architecture、DDD）の一貫した適用

**設計判断の明文化**:
- 重要な設計判断をADR（Architecture Decision Records）として記録
- トレードオフ・制約・代替案を文書化
- ディレクトリ構造・命名規則の統一

#### 動的可観測性のルール

**ログレベルの階層**: DEBUG（開発時）、INFO（正常動作）、WARN（潜在問題）、ERROR（システムエラー）

**構造化ログ**: メッセージ + 付加情報（キー・バリュー） + コンテキスト（自動付加）、機密情報除外

**レイヤー別責務**: ハンドラー（リクエスト/レスポンス）、ユースケース（ビジネスロジック）、インフラ（技術操作）、ドメイン（ログ出力なし）

### Procedure（行政）

可観測性を実現し、**AIの自己解決速度を最大化**し、**人間がシステムの責任を担保できる状態**を維持する。

#### 静的可観測性の実現

**コードによる意図の表現**: ドメインモデル・型定義・命名が業務概念と設計意図を直接表現する

**設計判断の永続化**: アーキテクチャ・トレードオフ・制約を構造化ドキュメントとして管理し、コード変更と同期更新する

#### 動的可観測性の実現

**実行状態の記録**: システム動作を構造化ログで記録し、AIが自律的に解析・診断できる形式で保存する

**コンテキストの保持**: リクエスト・セッション単位でトレース情報を保持し、問題発生時に迅速に原因を特定できる状態を維持する

### Review（司法）

可観測性の適切性を審査する。

#### 審査項目

**静的可観測性**:
- コード・型定義が意図を明確に表現しているか
- 複雑なロジックに「なぜ」の説明があるか
- 設計判断が文書化され、AIが理解可能か

**動的可観測性**:
- 重要な処理でログが適切に出力されているか
- ログレベル・構造化データ・機密情報除外が適切か
- 違反パターン（文字列連結、ドメイン層でのログ、エラーの文字列化）の検出

#### 実施方法

- **自動レビュー（MCP）**: コード変更時にAIが審査し、違反箇所を指摘・修正案提示
- **手動レビュー**: PRレビュー時に可観測性の適切性を確認

## 原則の適用

### 静的可観測性の実践

**コードで意図を表現**:
- 命名・型定義・インターフェースで「何を」「なぜ」を明示
- 複雑な条件分岐・ビジネスルールには説明コメント
- マジックナンバー・暗黙的な前提を排除

**継続的なドキュメント更新**:
- コード変更と同時にドキュメントを更新（陳腐化を防ぐ）
- 重要な設計判断をADRとして記録
- AIが自律的に参照できる構造を維持

### 動的可観測性の実践

**構造化ログの必須化**: 機械可読な形式（メッセージ + 付加情報）でAI解析を可能に。文字列連結禁止。

**レイヤー別責務の徹底**: ドメイン層はログ出力せず、エラーオブジェクトは文字列化せず元の形式で出力。

**機密情報の除外**: パスワード、トークン、個人情報を含めない。

**運用最適化**: 動的ログレベル変更、保管期間の階層化（ERROR/WARN長期、INFO中期、DEBUG短期）、コスト最適化。
