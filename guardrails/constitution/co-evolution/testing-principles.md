# テストの原則

## 最高原則

**テストピラミッドを構築し、高速なフィードバックと高い信頼性を両立する。** Small Testを厚く、E2Eを薄く。

---

## テストピラミッド

**下層を厚く、上層を薄く。各層の責務を重複させない。**

| 層 | 対象 | 特徴 |
|----|-----|------|
| Small | 純粋関数、ドメインモデル | 外部依存ゼロ、高速、網羅的 |
| Medium | DB、外部API | ローカルモック（LocalStack、MSW）で統合確認 |
| E2E | 結合動作 | 実環境、最小限（モック困難なもののみ） |

**本質**: Small Testで網羅し、Medium Testで統合を確認し、E2Eは最後の砦。

---

## 決定論的テスト

**同じ入力で常に同じ結果を返すテストを書く。**

非決定論的なテストはフレーキーになり、信頼を失う。

| 非決定要素 | 対策 |
|-----------|-----|
| 現在時刻 | ポートで注入、固定値 |
| 乱数 | シード固定、またはマスク |
| 外部API | モック |
| DB状態 | テストごとにクリーンアップ |

**本質**: テストが失敗したら、それは実装の問題であるべき。環境の問題ではない。

---

## テストの独立性

**各テストは他のテストに依存せず、単独で実行可能にする。**

- テストごとに新しいデータを作成
- 共有状態を避ける
- 実行順序に依存しない

**本質**: 並列実行可能で、失敗原因を特定しやすいテストを書く。

---

## 責務のMECE

**各テスト層は固有の責務を持ち、重複しない。**

| 層 | テストすべきこと | テストしないこと |
|----|----------------|----------------|
| Handler | 型制約（OpenAPI） | ビジネスルール |
| Domain | ドメインルール、不変条件 | 型制約 |
| UseCase | ビジネスルール | ドメインルール |
| E2E | 層を跨ぐ結合動作 | 単一層で検証可能なこと |

**本質**: 重複テストは保守コストを増やし、価値を生まない。

---

## 1テスト = 1検証

**1つのテストは1つのシナリオを検証する。**

- 失敗時に原因を即座に特定できる
- 条件分岐は別テストに分離
- テストは仕様の明示

---

## Dummyファクトリ

**テストデータはファクトリで生成し、保守性を高める。**

- ランダム値でデフォルト生成
- 必要なフィールドのみオーバーライド
- モデル変更時の修正を1箇所に集約

---

## evolutionとの関係

| 原則 | 焦点 | 関係 |
|-----|-----|-----|
| **evolution** | 変化への適応 | テストが変更を安全にする |
| **testing** | 品質の担保 | 進化を支える基盤 |

テストは変更を恐れずに進化するための安全網である。
