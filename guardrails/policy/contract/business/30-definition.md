# 定義（Definition）ポリシー

## 核心原則

定義は**ドメインモデルの唯一の源泉**である。概念・属性・制約・集約を記述し、Entity・Value Object・Repositoryはここから導出する。

## 責務

### 実施すること

1. **概念の定義**: ビジネスドメインの概念を明確に定義する
2. **属性の列挙**: 概念が持つ属性を列挙する
3. **制約の明示**: ビジネスルール・不変条件を記述する
4. **集約境界の明示**: 子エンティティは親の定義ファイルに併記する

### 実施しないこと

1. **振る舞いの詳細** → シナリオファイル（`40-scenario.md`参照）で記述
2. **技術的な型** → 実装層（server/domain/model）で決定
3. **API設計** → API契約（contracts/api）で定義

## 配置

```
/contracts
  /business
    /{domain}                    # 集約ルート名
      definition.md              # 集約ルート + 子エンティティ
```

## 記述形式

```markdown
# {概念名}

## 定義

{この概念が何であるか}

## 属性

- {属性名}：{説明}

## 制約

- {制約の説明}

## 集約（該当する場合）

- 集約ルート: {この概念が集約ルートの場合、自身}
- 所属集約: {この概念が子エンティティの場合、親の集約名}
- 子エンティティ: {集約ルートの場合、含まれる子エンティティのリスト}

## 参照関係（該当する場合）

- 参照元: {この概念を参照している他ドメインのリスト}
- 参照先: {この概念が参照している他ドメインのリスト}
```

## 集約の設計指針

### 同じ集約に含める（子エンティティとする）

- **ライフサイクルが同じ**: 親が削除されたら子も削除される
- **強い整合性が必要**: 同時に更新される必要がある
- **不変条件を共有**: 親子で1つのビジネスルールを守る

### 別の集約とする（ID参照のみ）

- **独立したライフサイクル**: 別々に作成・削除される
- **結果整合性で十分**: 即座の整合性が不要

## 用語集との整合性

定義は用語集から導出する。定義内のすべての用語は用語集に存在しなければならない。

### 概念名の一致

定義の見出し（`# {概念名}`）は用語集に存在し、英語名と一致する。

```markdown
// 用語集
| プロジェクト | Project | TODOをグループ化するための分類 |

// ✅ Good: 用語集と一致
# プロジェクト
→ project.entity.ts, class Project

// ❌ Bad: 用語集と不一致
# プロジェクト管理
→ 用語集に「プロジェクト管理」がない
```

### 属性で参照する概念

属性で参照する概念も用語集に存在する必要がある。

```markdown
// ✅ Good: 用語集に「プロジェクトメンバー」が存在
## 属性
- プロジェクトメンバー：プロジェクトに参加しているユーザー

// ❌ Bad: 用語集に「参加者」が存在しない
## 属性
- 参加者：プロジェクトに参加しているユーザー
```

## 集約設計の妥当性

集約設計は不変条件とライフサイクルに基づいて判断する。

### 不変条件の検証

親子で共有する制約があれば、同じ集約に含める。

```markdown
// 制約: 各プロジェクトには最低1人のオーナーが必要
// → ProjectMember は Project 集約の子（不変条件を共有）

// 制約: TODOには最大10個の添付ファイル
// → Attachment は Todo 集約の子（不変条件を共有）

// ユーザーは複数のプロジェクトに参加可能
// → User と Project は別集約（独立したライフサイクル）
```

### ライフサイクルの確認

親が削除されたとき子も削除される場合、同じ集約に含める。

```markdown
// ✅ Good: 同じ集約（親削除で子も削除）
Project削除 → ProjectMember も削除
Todo削除 → Attachment も削除

// ✅ Good: 別集約（独立したライフサイクル）
Project削除 → User は削除されない（ID参照のみ）
```

## Do / Don't

### Do: 子エンティティは親の定義ファイルに記載する

```
/contracts/business
  /project
    definition.md  ← Project と ProjectMember を両方記載
```

```markdown
# プロジェクト

## 定義
TODOをグループ化するための分類。

## 制約
- 各プロジェクトには最低1人のオーナーが必要

## 集約
- 集約ルート: プロジェクト
- 子エンティティ: プロジェクトメンバー

---

# プロジェクトメンバー

## 定義
プロジェクトに参加しているユーザー。

## 集約
- 所属集約: プロジェクト
```

### Don't: 子エンティティを別ディレクトリ・別ファイルで定義する

```
/contracts/business
  /project
    definition.md        ← Project のみ
  /project-member        ← ❌ 別ディレクトリを作ってしまう
    definition.md        ← ❌ 子エンティティを独立させてしまう
```

**なぜ問題か**:
- 「各プロジェクトには最低1人のオーナーが必要」という不変条件は、プロジェクトとメンバーで共有される
- 別ディレクトリにすると、実装時に別集約・別リポジトリとして誤って設計される
- 不変条件をトランザクション境界を跨いで検証することになり、整合性を保証できない

### 判断基準: 不変条件に注目する

制約に「親と子の両方に関わるルール」があれば、それは**同じ集約**である証拠：

| 制約の例 | 集約設計 |
|---------|---------|
| 「プロジェクトには最低1人のオーナーが必要」 | ProjectMember は Project 集約の子 |
| 「TODOには最大10個の添付ファイル」 | Attachment は Todo 集約の子 |
| 「ユーザーは複数のプロジェクトに参加可能」 | User と Project は別集約（ID参照） |

## 参照関係の管理

### なぜ参照関係を記録するか

**クロスドメインの影響を追跡可能にするため。**

定義変更時、同一ドメインのシナリオだけでなく、参照元ドメインへの影響も確認が必要。参照関係を明示することで、影響範囲の見落としを防ぐ。

### 参照関係の例

```markdown
// project/definition.md
# プロジェクト

## 参照関係
- 参照元: TODO（プロジェクトに所属）
- 参照先: ユーザー（プロジェクトメンバーとして参照）

// todo/definition.md
# TODO

## 参照関係
- 参照元: なし
- 参照先: プロジェクト（所属先）、ユーザー（担当者）
```

### 参照関係の更新タイミング

| タイミング | アクション |
|-----------|-----------|
| 新しいドメインを追加 | 参照先ドメインの「参照元」を更新 |
| 既存の参照を削除 | 参照先ドメインの「参照元」から削除 |
| 新しい参照を追加 | 参照先ドメインの「参照元」に追加 |

---

## 定義変更時の影響分析

**定義を変更したら、同一ドメインとクロスドメインの影響を確認する。**

### ステップ1: 同一ドメインの影響確認

同じドメインの既存シナリオへの影響を確認する。

### 必ず確認すべき変更

| 定義の変更 | 確認すべきシナリオの項目 |
|-----------|------------------------|
| 権限制約の追加 | 「誰が」セクション（アクターの変更が必要か） |
| 権限制約の追加 | 「例外」セクション（権限エラーの追加が必要か） |
| 属性の追加 | 「何を」「どうなる」セクション（新属性の反映が必要か） |
| 制約の追加 | 「例外」セクション（制約違反エラーの追加が必要か） |
| 子エンティティの追加 | 関連するシナリオの作成漏れがないか |

### 権限制約の波及

権限に関する制約（「〇〇のみが〜できる」）を追加した場合、既存シナリオの更新が必要になることが多い。

```markdown
// 定義に追加した制約:
// - プロジェクトオーナーのみがメンバーの追加・削除・ロール変更が可能

// 影響を受けるシナリオ:
// ❌ 更新前: create-project.md
## 誰が
ユーザー

## どうなる
- プロジェクトが作成される

// ✅ 更新後: create-project.md
## 誰が
ユーザー

## どうなる
- プロジェクトが作成される
- 作成者がプロジェクトオーナーになる  ← 追加

// ❌ 更新前: update-project.md
## 誰が
ユーザー

// ✅ 更新後: update-project.md
## 誰が
プロジェクトオーナー  ← 変更

## 例外
- プロジェクトオーナー以外は更新できない  ← 追加
```

### 同一ドメインのチェックリスト

定義変更時に以下を確認する:

1. **同一ドメインの全シナリオを列挙する**
2. **各シナリオの「誰が」が新しい制約と整合しているか確認する**
3. **各シナリオの「例外」が新しい制約と対応しているか確認する**
4. **新しい概念に対するシナリオ（CRUD、対称操作）が必要か検討する**

### ステップ2: クロスドメインの影響確認

参照関係を持つ他ドメインへの影響を確認する。

### クロスドメインで確認すべき変更

| 定義の変更 | 確認すべき参照元ドメイン |
|-----------|------------------------|
| 子エンティティの追加 | 参照元ドメインの属性・制約への影響 |
| 制約の追加 | 参照元ドメインのシナリオへの影響 |
| 属性の追加・変更 | 参照元ドメインで使用している属性への影響 |

### クロスドメインの確認例

```markdown
// プロジェクトに「プロジェクトメンバー」を追加した場合

1. 参照関係を確認:
   - プロジェクトの参照元: TODO

2. TODO側への影響を検討:
   - 担当者をプロジェクトメンバーから選択する制約が必要か？
   - プロジェクトに所属するTODOの振る舞いが変わるか？

3. 要件が曖昧な場合:
   - ユーザーに再ヒアリング（ワークフロー参照）
```

### クロスドメインのチェックリスト

1. **変更したドメインの「参照元」を確認する**
2. **各参照元ドメインの定義・シナリオへの影響を検討する**
3. **要件が曖昧な場合はユーザーに確認する**
4. **影響がある場合は参照元ドメインも更新する**

## 原則

| 原則 | 説明 |
|------|------|
| 用語集と一致 | 定義内の用語は用語集と完全に一致させる |
| 1ドメイン1ファイル | ドメイン単位で凝集させる |
| ビジネス視点 | 技術的な型や実装詳細は書かない |
| 属性と制約を併記 | 構造と不変条件を一体として定義 |
| 子は親に併記 | 子エンティティは親の定義ファイルに記載する |
| 参照関係を明示 | クロスドメインの依存関係を参照関係セクションに記録する |
| 同一ドメイン波及確認 | 定義変更時は同一ドメインのシナリオへの影響を確認する |
| クロスドメイン波及確認 | 定義変更時は参照元ドメインへの影響を確認する |
