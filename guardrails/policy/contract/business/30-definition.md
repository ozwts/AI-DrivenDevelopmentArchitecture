# 定義（Definition）ポリシー

## 核心原則

定義は**ドメインモデルの唯一の源泉**である。概念・属性・制約・集約を記述し、Entity・Value Object・Repositoryはここから導出する。

## 責務

### 実施すること

1. **概念の定義**: ビジネスドメインの概念を明確に定義する
2. **属性の列挙**: 概念が持つ属性を列挙する
3. **制約の明示**: ビジネスルール・不変条件を記述する
4. **集約境界の明示**: 子エンティティは親の定義ファイルに併記する

### 実施しないこと

1. **振る舞いの詳細** → シナリオファイル（`40-scenario.md`参照）で記述
2. **技術的な型** → 実装層（server/domain/model）で決定
3. **API設計** → API契約（contracts/api）で定義

## 配置

```
/contracts
  /business
    /{domain}                    # 集約ルート名
      definition.md              # 集約ルート + 子エンティティ
```

## 記述形式

```markdown
# {概念名}

## 定義

{この概念が何であるか}

## 属性

- {属性名}：{説明}

## 制約

- {制約の説明}

## 集約（該当する場合）

- 集約ルート: {この概念が集約ルートの場合、自身}
- 所属集約: {この概念が子エンティティの場合、親の集約名}
- 子エンティティ: {集約ルートの場合、含まれる子エンティティのリスト}
```

## 集約の設計指針

### 同じ集約に含める（子エンティティとする）

- **ライフサイクルが同じ**: 親が削除されたら子も削除される
- **強い整合性が必要**: 同時に更新される必要がある
- **不変条件を共有**: 親子で1つのビジネスルールを守る

### 別の集約とする（ID参照のみ）

- **独立したライフサイクル**: 別々に作成・削除される
- **結果整合性で十分**: 即座の整合性が不要

## 用語集との整合性

定義は用語集から導出する。定義内のすべての用語は用語集に存在しなければならない。

### 概念名の一致

定義の見出し（`# {概念名}`）は用語集に存在し、英語名と一致する。

```markdown
// 用語集
| プロジェクト | Project | TODOをグループ化するための分類 |

// ✅ Good: 用語集と一致
# プロジェクト
→ project.entity.ts, class Project

// ❌ Bad: 用語集と不一致
# プロジェクト管理
→ 用語集に「プロジェクト管理」がない
```

### 属性で参照する概念

属性で参照する概念も用語集に存在する必要がある。

```markdown
// ✅ Good: 用語集に「プロジェクトメンバー」が存在
## 属性
- プロジェクトメンバー：プロジェクトに参加しているユーザー

// ❌ Bad: 用語集に「参加者」が存在しない
## 属性
- 参加者：プロジェクトに参加しているユーザー
```

## 集約設計の妥当性

集約設計は不変条件とライフサイクルに基づいて判断する。

### 不変条件の検証

親子で共有する制約があれば、同じ集約に含める。

```markdown
// 制約: 各プロジェクトには最低1人のオーナーが必要
// → ProjectMember は Project 集約の子（不変条件を共有）

// 制約: TODOには最大10個の添付ファイル
// → Attachment は Todo 集約の子（不変条件を共有）

// ユーザーは複数のプロジェクトに参加可能
// → User と Project は別集約（独立したライフサイクル）
```

### ライフサイクルの確認

親が削除されたとき子も削除される場合、同じ集約に含める。

```markdown
// ✅ Good: 同じ集約（親削除で子も削除）
Project削除 → ProjectMember も削除
Todo削除 → Attachment も削除

// ✅ Good: 別集約（独立したライフサイクル）
Project削除 → User は削除されない（ID参照のみ）
```

## Do / Don't

### Do: 子エンティティは親の定義ファイルに記載する

```
/contracts/business
  /project
    definition.md  ← Project と ProjectMember を両方記載
```

```markdown
# プロジェクト

## 定義
TODOをグループ化するための分類。

## 制約
- 各プロジェクトには最低1人のオーナーが必要

## 集約
- 集約ルート: プロジェクト
- 子エンティティ: プロジェクトメンバー

---

# プロジェクトメンバー

## 定義
プロジェクトに参加しているユーザー。

## 集約
- 所属集約: プロジェクト
```

### Don't: 子エンティティを別ディレクトリ・別ファイルで定義する

```
/contracts/business
  /project
    definition.md        ← Project のみ
  /project-member        ← ❌ 別ディレクトリを作ってしまう
    definition.md        ← ❌ 子エンティティを独立させてしまう
```

**なぜ問題か**:
- 「各プロジェクトには最低1人のオーナーが必要」という不変条件は、プロジェクトとメンバーで共有される
- 別ディレクトリにすると、実装時に別集約・別リポジトリとして誤って設計される
- 不変条件をトランザクション境界を跨いで検証することになり、整合性を保証できない

### 判断基準: 不変条件に注目する

制約に「親と子の両方に関わるルール」があれば、それは**同じ集約**である証拠：

| 制約の例 | 集約設計 |
|---------|---------|
| 「プロジェクトには最低1人のオーナーが必要」 | ProjectMember は Project 集約の子 |
| 「TODOには最大10個の添付ファイル」 | Attachment は Todo 集約の子 |
| 「ユーザーは複数のプロジェクトに参加可能」 | User と Project は別集約（ID参照） |

## 原則

| 原則 | 説明 |
|------|------|
| 用語集と一致 | 定義内の用語は用語集と完全に一致させる |
| 1ドメイン1ファイル | ドメイン単位で凝集させる |
| ビジネス視点 | 技術的な型や実装詳細は書かない |
| 属性と制約を併記 | 構造と不変条件を一体として定義 |
| 子は親に併記 | 子エンティティは親の定義ファイルに記載する |
