# シナリオ（Scenario）ポリシー

## 核心原則

シナリオは**ユースケースの唯一の源泉**である。期待される振る舞いを定義し、UseCase・Handlerはここから導出する。

## 責務

### 実施すること

1. **振る舞いの定義**: ビジネス上の操作を「誰が・いつ・何を・どうなる」で記述する
2. **権限の明示**: 操作を実行できるアクターを明確にする
3. **例外の列挙**: エラーケースを網羅的に記述する

### 実施しないこと

1. **概念の定義** → 定義ファイル（`30-definition.md`参照）で記述
2. **技術的な実装詳細** → 実装層（server/use-case）で決定
3. **API設計** → API契約（contracts/api）で定義

## 配置

```
/contracts
  /business
    /{domain}                    # 集約ルート名
      /scenario
        {scenario-name}.md       # 1シナリオ1ファイル
```

## 記述形式

```markdown
# {シナリオ名}

## 目的

{ビジネス上の目的}

## 誰が

{権限・条件}

## いつ

{トリガー}

## 何を

{入力・対象}

## どうなる

{結果・状態変化}

## 例外

{エラーケース}
```

## 用語集との整合性

シナリオは用語集から導出する。シナリオ内のすべての用語は用語集に存在しなければならない。

### シナリオ名の一致

シナリオ名は用語集の動詞・概念から構成する。

```markdown
// 用語集: TODO → Todo, 登録する → register
// ✅ Good: 用語集と一致
# TODOを登録する
→ register-todo.md, RegisterTodoUseCase

// ❌ Bad: 用語集と不一致
# タスクを追加する  // 「タスク」「追加」が用語集にない
```

### アクターの一致

「誰が」のアクターは用語集に存在する必要がある。

```markdown
// 用語集: ユーザー → User
// ✅ Good
## 誰が
ユーザー

// ❌ Bad: 用語集に「利用者」がない
## 誰が
利用者
```

### 操作対象の一致

「何を」の操作対象は用語集に存在する必要がある。

```markdown
// 用語集: TODO → Todo, プロジェクト → Project
// ✅ Good
## 何を
- TODO ID
- プロジェクトID

// ❌ Bad: 用語集に「タスク」がない
## 何を
- タスクID
```

## 定義との整合性

シナリオは定義の属性・制約と整合する必要がある。

### 属性の参照

シナリオで参照する属性は定義に存在する。

```markdown
// 定義の属性: タイトル、説明、TODOステータス、優先度、期限
// ✅ Good: 定義の属性と一致
## 何を
- タイトル（必須）
- 説明
- 優先度
- 期限

// ❌ Bad: 定義にない属性を参照
## 何を
- タグ        // 定義に「タグ」属性がない
```

### 例外と制約の対応

シナリオの例外は定義の制約と対応する。

```markdown
// 定義の制約:
// - タイトルは必須
// - 担当者は必須（デフォルトは作成者）

// ✅ Good: 制約と対応する例外
## 例外
- タイトルが空の場合、登録できない  ← 制約「タイトルは必須」に対応
```

## Do / Don't

### Do: 子エンティティの操作は親のディレクトリに配置する

```
/contracts/business
  /project
    /scenario
      create-project.md
      invite-member.md     ← ProjectMember の操作も project 配下
      remove-member.md     ← ProjectMember の操作も project 配下
      list-members.md      ← ProjectMember の操作も project 配下
```

### Don't: 子エンティティの操作を別ディレクトリに配置する

```
/contracts/business
  /project
    /scenario
      create-project.md
  /project-member            ← ❌ 子エンティティを別ディレクトリに
    /scenario
      invite-member.md
      remove-member.md
```

**理由**: 定義と同様、契約の構造がそのまま実装の構造に反映される。

### Do: 用語集の用語をそのまま使用する

```markdown
## 誰が

プロジェクトオーナー         ← 用語集の「プロジェクトオーナー」をそのまま使用

## 何を

- プロジェクトID
- 招待するユーザーのメールアドレス

## どうなる

- 指定されたユーザーがプロジェクトメンバーとして追加される
                              ← 用語集の「プロジェクトメンバー」をそのまま使用
```

**重要**: 用語集の表記を変形して使用しない（「プロジェクトのオーナー」ではなく「プロジェクトオーナー」）

### Don't: 用語集にない概念を使用する

```markdown
// ❌ Bad: 用語集に「参加者」がない
## どうなる

- 指定されたユーザーが参加者として追加される

// ✅ Good: 用語集の「プロジェクトメンバー」を使用
## どうなる

- 指定されたユーザーがプロジェクトメンバーとして追加される
```

### Do: 例外を定義の制約と対応させる

```markdown
// 定義の制約:
// - 各プロジェクトには最低1人のオーナーが必要
// - オーナーのみがメンバーを招待・削除できる

// シナリオの例外:
## 例外

- オーナー以外は削除できない       ← 制約「オーナーのみが...」に対応
- オーナー自身は削除できない       ← 制約「最低1人のオーナーが必要」に対応
```

## シナリオの網羅性

機能の漏れを防ぐため、以下の観点でシナリオの網羅性を確認する。

### 対称性のある操作

対になる操作は両方定義する。片方だけでは機能として不完全。

| 操作 | 対になる操作 |
|------|-------------|
| 追加 | 削除 |
| 有効化 | 無効化 |
| 昇格 | 降格 |
| 開始 | 終了 |
| 購読 | 解除 |
| ロック | アンロック |

```
// ✅ Good: 対称性のある操作を両方定義
/scenario
  invite-member.md      ← メンバーを追加
  remove-member.md      ← メンバーを削除
  promote-to-owner.md   ← オーナーに昇格
  demote-from-owner.md  ← オーナーから降格

// ❌ Bad: 片方だけ定義
/scenario
  invite-member.md      ← 追加はあるが削除がない
  promote-to-owner.md   ← 昇格はあるが降格がない
```

### CRUDの検討

エンティティに対して、以下の操作が必要か検討する。

| 操作 | 検討観点 |
|------|---------|
| Create | 誰が、どのような条件で作成できるか |
| Read | 一覧取得、詳細取得、検索が必要か |
| Update | どの属性を変更できるか |
| Delete | 削除できるか、論理削除か物理削除か |

不要な操作は定義しないが、**必要性を検討した上で除外**する。

### 状態遷移の網羅

状態を持つエンティティは、全ての遷移パターンを検討する。

```
// TODOステータス: 未着手 → 作業中 → 完了
// 検討すべき遷移:
// - 未着手 → 作業中 ✅
// - 作業中 → 完了 ✅
// - 完了 → 未着手（差し戻し）は必要か？
// - 作業中 → 未着手（中断）は必要か？
```

## 1シナリオ = 1ユースケース

シナリオはユースケースと1対1で対応する。1つのシナリオが1つのユースケースに導出される。

### 汎用的なユースケースを作らない

異なるビジネス意図を持つ操作は、別々のシナリオ・ユースケースとして定義する。

```
// ✅ Good: 意図ごとに分離
promote-to-owner.md  → PromoteToOwnerUseCase
demote-from-owner.md → DemoteFromOwnerUseCase

// ❌ Bad: 汎用化
change-role.md       → ChangeRoleUseCase（内部で条件分岐）
```

**理由**:

| 観点 | 分離のメリット |
|------|---------------|
| 意図の明確さ | 「昇格したい」と「降格したい」は別の目的 |
| 権限の違い | 昇格と降格で異なる権限が必要な場合がある |
| 制約の違い | 「最後のオーナーは降格できない」など固有の制約 |
| テスト容易性 | シナリオがそのままテストケースになる |
| 監査・追跡 | ビジネス上、別々のイベントとして記録できる |

## 原則

| 原則 | 説明 |
|------|------|
| 用語集と一致 | シナリオ内の用語は用語集と完全に一致させる |
| 1シナリオ1ファイル | シナリオ単位で凝集させる |
| 1シナリオ1ユースケース | シナリオとユースケースは1対1で対応する |
| ビジネス視点 | 技術的な実装詳細は書かない |
| 権限を明示 | 誰が実行できるかを明確にする |
| 入出力を明示 | 何を渡して何が変わるかを明確にする |
| 親に集約 | 子エンティティの操作は親のディレクトリに配置する |
| 対称性を確保 | 対になる操作は両方定義する |
