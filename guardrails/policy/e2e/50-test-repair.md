# テスト修復ポリシー

## 核心原則

E2Eテスト失敗時は**目先の修正ではなく、あるべき修正**を行う。テストを通すことが目的ではなく、**テストが露呈した問題の根本原因を解決**することが目的である。

**根拠となる憲法**:
- `testing-principles.md`: テストは品質を検証する手段
- `collaboration-principles.md`: AIと人間の協調による品質向上

## 修正の原則

| 原則 | 説明 |
|------|------|
| あるべき修正を行う | 応急処置より根本解決を優先 |
| ポリシー準拠 | 憲法とポリシーに従った堅牢な解決策 |
| テストの堅牢性 | UI変更に強いロケータ、Page Object活用 |
| 1つずつ修正 | 複数エラーがある場合は1つずつ修正して再テスト |
| 理由を明確化 | 各修正の理由を文書化 |

## 修正対象の判断基準

テスト失敗時、以下の順序で原因を判断する：

```
テスト失敗
    │
    ▼
テストコードの問題か？ ─Yes→ テストを修正
    │No
    ▼
アプリケーションのバグか？ ─Yes→ アプリを修正
    │No
    ▼
UX設計の問題か？ ─Yes→ アプリのUI設計を修正
    │No
    ▼
環境・データの問題 → 環境設定を修正
```

### 判断の詳細

| 原因カテゴリ | 判断基準 | 修正対象 |
|-------------|----------|----------|
| テストコードの問題 | ロケータ誤り、タイミング問題、データ依存 | テスト |
| アプリのバグ | 実装の誤り、API不整合、期待動作との乖離 | アプリ |
| UX設計の問題 | 重複UI、曖昧なラベル、一貫性のない操作 | アプリのUI |
| 環境・データの問題 | テストデータ不足、環境設定ミス | 環境設定 |

## 根本原因分析の観点

### フロントエンド観点

| 観点 | 確認内容 |
|------|----------|
| セレクタ変更 | UI変更によりロケータが無効化されていないか |
| タイミング問題 | 非同期処理の待機が適切か |
| データ依存 | テストデータが存在するか、他テストと干渉していないか |
| アプリ変更 | テストの前提を壊す機能変更がないか |

### サーバーログ観点

サーバーログから以下を確認し、フロント/サーバーどちらの問題かを切り分ける：

| ログ内容 | 示唆する問題 | 修正対象 |
|----------|-------------|----------|
| 4xx エラー | リクエスト形式の不整合 | フロント or API仕様 |
| 5xx エラー | サーバー側の実装バグ | サーバー |
| リクエスト未到達 | フロントのAPI呼び出し失敗 | フロント |
| 期待と異なるレスポンス | API仕様の不整合 | 契約（OpenAPI）確認 |

### API不整合の切り分け

```
APIエラー発生
    │
    ▼
OpenAPI仕様を確認
    │
    ├─ フロントが仕様と異なる → フロント修正
    ├─ サーバーが仕様と異なる → サーバー修正
    └─ 仕様自体が古い → 契約（OpenAPI）更新
```

## UX問題の検出パターン

以下のエラーパターンは**アプリ側のUX問題**を示唆している。テストを回避策で修正するのではなく、アプリケーション側のUI設計を見直す。

### strict mode violation

```
Error: strict mode violation: getByRole('button', { name: 'XXX' }) resolved to N elements
```

**意味**: 同一ラベルの要素が複数存在する

**よくある原因と対処**:

| 原因 | 例 | 対処 |
|------|-----|------|
| 同一機能のボタン重複 | ヘッダーとEmptyState両方に「新規作成」 | 一方を削除、または誘導テキストに変更 |
| リスト内の同名アクション | 各行に同じ「削除」ボタン | 行コンテキスト内でLocatorを絞り込む（テスト修正） |
| モーダル外の要素が見える | モーダル内外に同名ボタン | モーダルコンテナ内でLocatorを絞り込む（テスト修正） |

**判断基準**:
- 「同一機能の重複」→ **UX問題（アプリ修正）**
- 「異なるコンテキストの同名」→ **ロケータの問題（テスト修正）**

### 曖昧なラベル

```
Error: getByRole('button', { name: '送信' }) - 何を送信するか不明
```

**対処**: ボタンラベルを具体的にする（例: 「コメントを送信」「フォームを送信」）

## 回避策を選ぶべきケース

以下の場合のみ、テスト側での回避策が許容される：

| ケース | 回避策 | 理由 |
|--------|--------|------|
| リスト内の同名要素 | 親要素で絞り込み | 各行に同じアクションがあるのは正常なUI |
| モーダル内の要素 | モーダルコンテナで絞り込み | モーダル外の要素は視覚的に無効化されている |
| 動的に生成される要素 | `nth()`や`filter()`で絞り込み | IDがない動的リストは許容される設計 |

**注意**: `.first()` を安易に使用しない。なぜその要素が最初なのか、将来も保証されるかを考慮する。

## Do / Don't

### ✅ Good: UX問題を検出してアプリを修正

```typescript
// Before: EmptyStateとヘッダー両方に「新規TODO」ボタン
// → strict mode violation

// After: EmptyStateからボタンを削除、誘導テキストに変更
<EmptyState
  title="TODOがありません"
  description="右上の「新規TODO」ボタンから作成できます"
/>
```

### ❌ Bad: テスト側で回避

```typescript
// UX問題を放置し、テストで回避
await page.getByRole("button", { name: "新規TODO" }).first().click();
// → ユーザーも同じ混乱を経験する
```

### ✅ Good: コンテキスト内で絞り込み

```typescript
// リスト内の各行に「削除」ボタンがある場合
// → これはUX問題ではなく、正常なパターン
const targetRow = page.getByRole("row").filter({ hasText: targetTitle });
await targetRow.getByRole("button", { name: "削除" }).click();
```

## 修正後の確認

修正後は以下を確認する：

| 確認項目 | 方法 |
|----------|------|
| テストが成功する | E2Eテスト再実行 |
| スナップショット更新 | UI変更時は `test:ss:update` |
| 他のテストへの影響 | 全E2Eテスト実行 |
| UXの改善 | 実際にブラウザで操作確認 |

## 関連ドキュメント

- `10-e2e-overview.md`: E2Eテスト概要
- `20-page-object-pattern.md`: Page Objectパターン
- `30-test-patterns.md`: シナリオ設計パターン
