# 機能要件: プロジェクトメンバー招待機能

## 概要

プロジェクトに他のユーザーを招待し、共同でTodoを管理できる機能を追加する。

## ビジネス要件

### ユースケース

1. **プロジェクトオーナー**が他のユーザーをメンバーとして招待できる
2. **招待されたユーザー**は招待を承認/拒否できる
3. **メンバー**はプロジェクト内のTodoを閲覧・編集できる
4. **オーナー**はメンバーを削除できる

### ロール定義

| ロール | 権限 |
|--------|------|
| owner | 全操作（招待、削除、プロジェクト編集、Todo操作） |
| member | Todo閲覧・編集のみ（プロジェクト設定変更不可） |

### 制約

- 1プロジェクトあたり最大10名（オーナー含む）
- 自分自身は招待不可
- 既存メンバーの重複招待不可
- 招待は7日間有効（期限切れで自動削除）

## API設計（案）

### エンドポイント

```yaml
# メンバー一覧取得
GET /projects/{projectId}/members
Response: { members: [{ userId, displayName, role, joinedAt }] }

# 招待作成
POST /projects/{projectId}/invitations
Request: { email: string }
Response: { invitationId, expiresAt }

# 招待一覧取得（オーナー用）
GET /projects/{projectId}/invitations
Response: { invitations: [{ id, email, status, createdAt, expiresAt }] }

# 招待承認（招待されたユーザー用）
POST /invitations/{invitationId}/accept
Response: { projectId, role }

# 招待拒否
POST /invitations/{invitationId}/decline
Response: {}

# 自分への招待一覧
GET /me/invitations
Response: { invitations: [{ id, projectName, inviterName, expiresAt }] }

# メンバー削除
DELETE /projects/{projectId}/members/{userId}
Response: {}
```

## ドメインモデル（案）

### 新規エンティティ

```typescript
// ProjectMember（プロジェクトメンバー）
{
  projectId: string;
  userId: string;
  role: "owner" | "member";
  joinedAt: string;
}

// Invitation（招待）
{
  id: string;
  projectId: string;
  inviterUserId: string;
  inviteeEmail: string;
  status: "pending" | "accepted" | "declined" | "expired";
  createdAt: string;
  expiresAt: string;
}
```

### 既存エンティティへの影響

- `Project`: メンバー管理メソッド追加の可能性
- `Todo`: 権限チェックロジック追加

## フロントエンド設計（案）

### 新規画面

1. **メンバー管理画面** `/projects/{projectId}/members`
   - メンバー一覧表示
   - 招待フォーム
   - 招待状況一覧

2. **招待一覧画面** `/invitations`
   - 自分への招待一覧
   - 承認/拒否ボタン

### 既存画面への変更

- **プロジェクト詳細**: メンバー管理へのリンク追加
- **ヘッダー**: 招待通知バッジ

## インフラ設計（案）

### DynamoDB

```
# ProjectMember テーブル or GSI
PK: PROJECT#{projectId}
SK: MEMBER#{userId}

# Invitation テーブル or GSI
PK: INVITATION#{invitationId}
GSI1: inviteeEmail（メールで検索）
GSI2: projectId（プロジェクトで検索）
```

## E2Eテストシナリオ

1. **招待フロー**
   - オーナーがメンバーを招待
   - 招待されたユーザーがログイン
   - 招待を承認
   - プロジェクトにアクセス可能になる

2. **権限テスト**
   - メンバーがプロジェクト設定を変更しようとする → 403

3. **期限切れテスト**
   - 期限切れ招待の承認 → エラー

## 優先順位

Phase 1（MVP）:
- 招待作成・承認・拒否
- メンバー一覧表示
- 基本的な権限チェック

Phase 2（拡張）:
- 招待期限管理
- メンバー上限チェック
- 通知機能

---

## ワークフロー実行指示

上記要件に基づき、以下のフェーズで実装を進める:

1. **Contract**: ビジネス契約 + API仕様（OpenAPI）
2. **Policy**: 新規ポリシー策定（権限管理、招待ルール）
3. **Frontend**: mockモードで先行実装
4. **Server**: fullモードで実装
5. **Infra**: DynamoDB設計変更
6. **E2E**: 統合テスト

`mcp__guardrails__procedure_workflow(action='plan')` でタスク計画を開始。
