{
  "name": "infra",
  "version": "0.0.0",
  "scripts": {
    "build": "cd .. && npm run build -w web && npm run api:build -w server",
    "build:branch": "cd .. && npm run build:branch -w web && npm run api:build -w server",
    "api:build": "cd .. && npm run api:build -w server",
    "web:build": "cd .. && npm run build -w web",
    "web:build:branch": "cd .. && npm run build:branch -w web",

    "fix": "terraform fmt -recursive terraform/",
    "fix:format": "npm run fix",
    "fix:check": "terraform fmt -check -recursive terraform/",

    "lint:init": "tflint --init --chdir=terraform",
    "lint": "npm run lint:init && tflint --recursive --chdir=terraform",
    "lint:dev": "npm run lint:init && tflint --chdir=terraform/environments/dev --config=../../.tflint.hcl",
    "lint:stg": "npm run lint:init && tflint --chdir=terraform/environments/stg --config=../../.tflint.hcl",
    "lint:prd": "npm run lint:init && tflint --chdir=terraform/environments/prd --config=../../.tflint.hcl",
    "lint:deep:dev": "npm run lint:init && tflint --chdir=terraform/environments/dev --config=../../.tflint.deep.hcl",
    "lint:deep:stg": "npm run lint:init && tflint --chdir=terraform/environments/stg --config=../../.tflint.deep.hcl",
    "lint:deep:prd": "npm run lint:init && tflint --chdir=terraform/environments/prd --config=../../.tflint.deep.hcl",

    "security": "npm run security:dev && npm run security:stg && npm run security:prd",
    "security:dev": "trivy config --config terraform/trivy.yaml --ignorefile terraform/environments/dev/.trivyignore terraform/environments/dev",
    "security:stg": "trivy config --config terraform/trivy.yaml --ignorefile terraform/environments/stg/.trivyignore terraform/environments/stg",
    "security:prd": "trivy config --config terraform/trivy.yaml --ignorefile terraform/environments/prd/.trivyignore terraform/environments/prd",

    "validate": "npm run validate:dev",
    "validate:dev": "npm run fix:check && npm run lint:dev && npm run security:dev",
    "validate:stg": "npm run fix:check && npm run lint:stg && npm run security:stg",
    "validate:prd": "npm run fix:check && npm run lint:prd && npm run security:prd",
    "validate:all": "npm run fix:check && npm run lint && npm run security",
    "validate:deep": "npm run validate:deep:dev",
    "validate:deep:dev": "npm run fix:check && npm run lint:deep:dev && npm run security:dev",
    "validate:deep:stg": "npm run fix:check && npm run lint:deep:stg && npm run security:stg",
    "validate:deep:prd": "npm run fix:check && npm run lint:deep:prd && npm run security:prd",

    "config:dev": "terraform -chdir=terraform/environments/dev init --reconfigure",
    "config:stg": "terraform -chdir=terraform/environments/stg init --reconfigure",
    "config:prd": "terraform -chdir=terraform/environments/prd init --reconfigure",
    "config:branch:dev": "terraform -chdir=terraform/environments/dev init -reconfigure -backend-config=\"key=terraform/dev-$(git branch --show-current | shasum | cut -c1-7).tfstate\"",
    "config:upgrade:dev": "terraform -chdir=terraform/environments/dev init -upgrade",
    "config:upgrade:stg": "terraform -chdir=terraform/environments/stg init -upgrade",
    "config:upgrade:prd": "terraform -chdir=terraform/environments/prd init -upgrade",
    "config:upgrade:branch:dev": "terraform -chdir=terraform/environments/dev init -upgrade -backend-config=\"key=terraform/dev-$(git branch --show-current | shasum | cut -c1-7).tfstate\"",

    "diff:dev": "npm run build && npm run validate:dev && npm run config:dev && terraform -chdir=terraform/environments/dev plan",
    "diff:stg": "npm run build && npm run validate:stg && npm run config:stg && terraform -chdir=terraform/environments/stg plan",
    "diff:prd": "npm run build && npm run validate:prd && npm run config:prd && terraform -chdir=terraform/environments/prd plan",
    "diff:branch:dev": "npm run build:branch && npm run validate:dev && npm run config:branch:dev && terraform -chdir=terraform/environments/dev plan -var=\"branch_suffix=$(git branch --show-current | shasum | cut -c1-7)\"",

    "deploy:dev": "npm run build && npm run validate:dev && npm run config:dev && terraform -chdir=terraform/environments/dev apply --auto-approve",
    "deploy:stg": "npm run build && npm run validate:stg && npm run config:stg && terraform -chdir=terraform/environments/stg apply --auto-approve",
    "deploy:prd": "npm run build && npm run validate:prd && npm run config:prd && terraform -chdir=terraform/environments/prd apply",
    "deploy:api:dev": "npm run api:build && terraform -chdir=terraform/environments/dev apply -target=module.db -target=module.server --auto-approve",
    "deploy:web:dev": "npm run web:build && terraform -chdir=terraform/environments/dev apply -target=module.static_site --auto-approve",
    "deploy:branch:dev": "npm run build:branch && npm run validate:dev && npm run config:branch:dev && terraform -chdir=terraform/environments/dev apply -var=\"branch_suffix=$(git branch --show-current | shasum | cut -c1-7)\" --auto-approve",
    "deploy:branch:api:dev": "npm run api:build && npm run config:branch:dev && terraform -chdir=terraform/environments/dev apply -target=module.db -target=module.server -target=module.server_params -var=\"branch_suffix=$(git branch --show-current | shasum | cut -c1-7)\" --auto-approve",
    "deploy:branch:web:dev": "npm run web:build:branch && npm run config:branch:dev && terraform -chdir=terraform/environments/dev apply -target=module.static_site -target=module.web_params -var=\"branch_suffix=$(git branch --show-current | shasum | cut -c1-7)\" --auto-approve",

    "destroy:dev": "terraform -chdir=terraform/environments/dev destroy",
    "destroy:stg": "terraform -chdir=terraform/environments/stg destroy",
    "destroy:prd": "terraform -chdir=terraform/environments/prd destroy",
    "destroy:branch:dev": "cd .. && npm run user:destroy:branch -w e2e && cd infra && npm run config:branch:dev && terraform -chdir=terraform/environments/dev destroy -var=\"branch_suffix=$(git branch --show-current | shasum | cut -c1-7)\" --auto-approve"
  }
}
