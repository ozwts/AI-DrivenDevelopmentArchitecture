openapi: 3.0.2
info:
  title: Consultant TODO App API
  version: 0.1.0
  description: コンサルタント向けTODO管理アプリケーションのAPI
tags:
  - name: todos
    description: TODOアイテム
  - name: projects
    description: プロジェクト
  - name: users
    description: ユーザー
  - name: health
    description: ヘルスチェック
paths:
  /health:
    get:
      tags:
        - health
      summary: ヘルスチェック
      responses:
        "200":
          description: サーバーが正常に動作している
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /todos:
    get:
      tags:
        - todos
      summary: TODOのリストを取得
      parameters:
        - name: status
          in: query
          description: ステータスでフィルター
          required: false
          schema:
            $ref: "#/components/schemas/TodoStatus"
        - name: projectId
          in: query
          description: プロジェクトIDでフィルター
          required: false
          schema:
            type: string
      responses:
        "200":
          description: TODOリスト取得に成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TodosResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      tags:
        - todos
      summary: 新しいTODOを作成
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterTodoParams"
      responses:
        "201":
          description: TODO作成に成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TodoResponse"
        "400":
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /projects:
    get:
      tags:
        - projects
      summary: プロジェクトのリストを取得
      responses:
        "200":
          description: プロジェクトリスト取得に成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProjectsResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      tags:
        - projects
      summary: 新しいプロジェクトを作成
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateProjectParams"
      responses:
        "201":
          description: プロジェクト作成に成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProjectResponse"
        "400":
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /projects/{projectId}:
    get:
      tags:
        - projects
      summary: プロジェクトの詳細を取得
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
          description: プロジェクトID
      responses:
        "200":
          description: プロジェクト詳細取得に成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProjectResponse"
        "404":
          description: プロジェクトが存在しない
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    put:
      tags:
        - projects
      summary: プロジェクトを更新
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
          description: プロジェクトID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateProjectParams"
      responses:
        "200":
          description: プロジェクト更新に成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProjectResponse"
        "400":
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: プロジェクトが存在しない
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      tags:
        - projects
      summary: プロジェクトを削除
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
          description: プロジェクトID
      responses:
        "204":
          description: プロジェクト削除に成功
        "404":
          description: プロジェクトが存在しない
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /users:
    get:
      tags:
        - users
      summary: ユーザーのリストを取得
      responses:
        "200":
          description: ユーザーリスト取得に成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UsersResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /users/me:
    get:
      tags:
        - users
      summary: 現在のユーザーの詳細を取得
      description: 認証トークンから現在のユーザー情報を取得する
      responses:
        "200":
          description: ユーザー詳細取得に成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "404":
          description: ユーザーが存在しない
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      tags:
        - users
      summary: 現在のユーザーを登録
      description: Cognito認証後の初回ログイン時にユーザー情報をDBに同期する。認証トークンからsub/email/emailVerifiedを取得する。
      responses:
        "201":
          description: ユーザー登録に成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "400":
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    put:
      tags:
        - users
      summary: 現在のユーザー情報を更新
      description: 認証トークンから現在のユーザーを特定して情報を更新する
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateUserParams"
      responses:
        "200":
          description: ユーザー更新に成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "400":
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: ユーザーが存在しない
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      tags:
        - users
      summary: 現在のユーザーを削除
      description: 認証トークンから現在のユーザーを特定して削除する。ユーザーは自分自身のアカウントのみ削除可能。
      responses:
        "204":
          description: ユーザー削除に成功
        "404":
          description: ユーザーが存在しない
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /users/{userId}:
    get:
      tags:
        - users
      summary: ユーザーの詳細を取得
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
          description: ユーザーID
      responses:
        "200":
          description: ユーザー詳細取得に成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "404":
          description: ユーザーが存在しない
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /todos/{todoId}:
    get:
      tags:
        - todos
      summary: TODOの詳細を取得
      parameters:
        - name: todoId
          in: path
          required: true
          schema:
            type: string
          description: TODO ID
      responses:
        "200":
          description: TODO詳細取得に成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TodoResponse"
        "404":
          description: TODOが存在しない
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    put:
      tags:
        - todos
      summary: TODOを更新
      parameters:
        - name: todoId
          in: path
          required: true
          schema:
            type: string
          description: TODO ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateTodoParams"
      responses:
        "200":
          description: TODO更新に成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TodoResponse"
        "400":
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: TODOが存在しない
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      tags:
        - todos
      summary: TODOを削除
      parameters:
        - name: todoId
          in: path
          required: true
          schema:
            type: string
          description: TODO ID
      responses:
        "204":
          description: TODO削除に成功
        "404":
          description: TODOが存在しない
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /todos/{todoId}/attachments:
    get:
      tags:
        - todos
      summary: TODOの添付ファイル一覧を取得
      description: アップロード完了済みの添付ファイルのみを返す
      parameters:
        - name: todoId
          in: path
          required: true
          schema:
            type: string
          description: TODO ID
      responses:
        "200":
          description: 添付ファイル一覧取得に成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AttachmentsResponse"
        "404":
          description: TODOが存在しない
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      tags:
        - todos
      summary: 添付ファイルをアップロード準備
      description: |
        ファイルメタデータを登録し、一時的なアップロードURLを取得する。
        この時点でAttachmentはpreparedステータスで作成される。
        実際のファイルアップロード後にPUTでステータスをuploadedに更新する必要がある。
      parameters:
        - name: todoId
          in: path
          required: true
          schema:
            type: string
          description: TODO ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PrepareAttachmentParams"
      responses:
        "201":
          description: 添付ファイル準備に成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PrepareAttachmentResponse"
        "400":
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: TODOが存在しない
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /todos/{todoId}/attachments/{attachmentId}:
    get:
      tags:
        - todos
      summary: 添付ファイルの詳細を取得
      parameters:
        - name: todoId
          in: path
          required: true
          schema:
            type: string
          description: TODO ID
        - name: attachmentId
          in: path
          required: true
          schema:
            type: string
          description: 添付ファイルID
      responses:
        "200":
          description: 添付ファイル詳細取得に成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AttachmentResponse"
        "404":
          description: 添付ファイルが存在しない
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    put:
      tags:
        - todos
      summary: 添付ファイルのステータスを更新
      description: アップロード完了後、ステータスをuploadedに更新する
      parameters:
        - name: todoId
          in: path
          required: true
          schema:
            type: string
          description: TODO ID
        - name: attachmentId
          in: path
          required: true
          schema:
            type: string
          description: 添付ファイルID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateAttachmentParams"
      responses:
        "200":
          description: 添付ファイル更新に成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AttachmentResponse"
        "400":
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: 添付ファイルが存在しない
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      tags:
        - todos
      summary: 添付ファイルを削除
      description: 添付ファイルとそのメタデータを削除する
      parameters:
        - name: todoId
          in: path
          required: true
          schema:
            type: string
          description: TODO ID
        - name: attachmentId
          in: path
          required: true
          schema:
            type: string
          description: 添付ファイルID
      responses:
        "204":
          description: 添付ファイル削除に成功
        "404":
          description: 添付ファイルが存在しない
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /todos/{todoId}/attachments/{attachmentId}/download-url:
    get:
      tags:
        - todos
      summary: 添付ファイルのダウンロードURLを取得
      description: 一時的なダウンロードURLを取得する
      parameters:
        - name: todoId
          in: path
          required: true
          schema:
            type: string
          description: TODO ID
        - name: attachmentId
          in: path
          required: true
          schema:
            type: string
          description: 添付ファイルID
      responses:
        "200":
          description: ダウンロードURL取得に成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DownloadUrlResponse"
        "404":
          description: 添付ファイルが存在しない
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  schemas:
    HealthResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          description: サーバーのステータス
          example: healthy

    TodoStatus:
      type: string
      enum:
        - TODO
        - IN_PROGRESS
        - DONE
      description: TODOのステータス

    TodoPriority:
      type: string
      enum:
        - LOW
        - MEDIUM
        - HIGH
      description: TODOの優先度

    TodoResponse:
      type: object
      required:
        - id
        - title
        - status
        - priority
        - assigneeUserId
        - createdAt
        - updatedAt
        - attachments
      properties:
        id:
          type: string
          description: TODOの一意の識別子
        title:
          type: string
          description: TODOのタイトル
        description:
          type: string
          description: TODOの詳細説明
        status:
          $ref: "#/components/schemas/TodoStatus"
        priority:
          $ref: "#/components/schemas/TodoPriority"
        dueDate:
          type: string
          format: date
          description: 期限日
        projectId:
          type: string
          description: プロジェクトID
        assigneeUserId:
          type: string
          description: 担当者のユーザーID
        attachments:
          $ref: "#/components/schemas/AttachmentsResponse"
        createdAt:
          type: string
          format: date-time
          description: 作成日時
        updatedAt:
          type: string
          format: date-time
          description: 更新日時

    TodosResponse:
      type: array
      items:
        $ref: "#/components/schemas/TodoResponse"

    RegisterTodoParams:
      type: object
      required:
        - title
      properties:
        title:
          type: string
          description: TODOのタイトル
          minLength: 1
          maxLength: 200
        description:
          type: string
          description: TODOの詳細説明
          maxLength: 5000
        status:
          $ref: "#/components/schemas/TodoStatus"
        priority:
          $ref: "#/components/schemas/TodoPriority"
        dueDate:
          type: string
          format: date
          description: 期限日
        projectId:
          type: string
          description: プロジェクトID
        assigneeUserId:
          type: string
          description: 担当者のユーザーID（省略時は作成者が担当者になる）

    UpdateTodoParams:
      type: object
      properties:
        title:
          type: string
          description: TODOのタイトル
          minLength: 1
          maxLength: 200
        description:
          type: string
          description: TODOの詳細説明
          maxLength: 5000
        status:
          $ref: "#/components/schemas/TodoStatus"
        priority:
          $ref: "#/components/schemas/TodoPriority"
        dueDate:
          type: string
          format: date
          description: 期限日
        projectId:
          type: string
          description: プロジェクトID
        assigneeUserId:
          type: string
          description: 担当者のユーザーID

    ProjectResponse:
      type: object
      required:
        - id
        - name
        - color
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          description: プロジェクトの一意の識別子
        name:
          type: string
          description: プロジェクト名
        description:
          type: string
          description: プロジェクトの説明
        color:
          type: string
          description: プロジェクトのカラーコード（例：#001964）
        createdAt:
          type: string
          format: date-time
          description: 作成日時
        updatedAt:
          type: string
          format: date-time
          description: 更新日時

    ProjectsResponse:
      type: array
      items:
        $ref: "#/components/schemas/ProjectResponse"

    CreateProjectParams:
      type: object
      required:
        - name
        - color
      properties:
        name:
          type: string
          description: プロジェクト名
          minLength: 1
          maxLength: 100
        description:
          type: string
          description: プロジェクトの説明
          maxLength: 1000
        color:
          type: string
          description: プロジェクトのカラーコード（例：#001964）
          pattern: "^#[0-9A-Fa-f]{6}$"

    UpdateProjectParams:
      type: object
      properties:
        name:
          type: string
          description: プロジェクト名
          minLength: 1
          maxLength: 100
        description:
          type: string
          description: プロジェクトの説明
          maxLength: 1000
        color:
          type: string
          description: プロジェクトのカラーコード（例：#001964）
          pattern: "^#[0-9A-Fa-f]{6}$"

    UserResponse:
      type: object
      required:
        - id
        - sub
        - name
        - email
        - emailVerified
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          description: ユーザーID
        sub:
          type: string
          description: Cognito User Sub (外部認証システムの識別子)
        name:
          type: string
          description: ユーザー名
        email:
          type: string
          description: メールアドレス
        emailVerified:
          type: boolean
          description: メール検証済みフラグ
        createdAt:
          type: string
          format: date-time
          description: 作成日時
        updatedAt:
          type: string
          format: date-time
          description: 更新日時

    UsersResponse:
      type: array
      items:
        $ref: "#/components/schemas/UserResponse"

    UpdateUserParams:
      type: object
      properties:
        name:
          type: string
          description: ユーザー名
          minLength: 1
          maxLength: 100

    ErrorResponse:
      type: object
      required:
        - name
        - message
      properties:
        name:
          type: string
          description: エラー名
        message:
          type: string
          description: エラーメッセージ

    AttachmentStatus:
      type: string
      enum:
        - PREPARED
        - UPLOADED
      description: 添付ファイルのステータス（PREPARED=アップロード準備中、UPLOADED=アップロード完了）

    AttachmentResponse:
      type: object
      required:
        - id
        - todoId
        - filename
        - contentType
        - size
        - status
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          description: 添付ファイルの一意の識別子
        todoId:
          type: string
          description: TODO ID
        filename:
          type: string
          description: ファイル名
        contentType:
          type: string
          description: MIMEタイプ（例：image/png, application/pdf）
        size:
          type: integer
          format: int64
          description: ファイルサイズ（バイト）
        status:
          $ref: "#/components/schemas/AttachmentStatus"
        createdAt:
          type: string
          format: date-time
          description: 作成日時
        updatedAt:
          type: string
          format: date-time
          description: 更新日時

    AttachmentsResponse:
      type: array
      items:
        $ref: "#/components/schemas/AttachmentResponse"

    PrepareAttachmentParams:
      type: object
      required:
        - filename
        - contentType
        - size
      properties:
        filename:
          type: string
          description: ファイル名
          minLength: 1
          maxLength: 255
        contentType:
          type: string
          description: MIMEタイプ（例：image/png, application/pdf）
          minLength: 1
          maxLength: 100
        size:
          type: integer
          format: int64
          description: ファイルサイズ（バイト）
          minimum: 1
          maximum: 10485760

    PrepareAttachmentResponse:
      type: object
      required:
        - attachment
        - uploadUrl
      properties:
        attachment:
          $ref: "#/components/schemas/AttachmentResponse"
        uploadUrl:
          type: string
          description: 一時的なアップロードURL（有効期限あり）

    UpdateAttachmentParams:
      type: object
      required:
        - status
      properties:
        status:
          $ref: "#/components/schemas/AttachmentStatus"

    DownloadUrlResponse:
      type: object
      required:
        - downloadUrl
      properties:
        downloadUrl:
          type: string
          description: 一時的なダウンロードURL（有効期限あり）
